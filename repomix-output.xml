This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
.idx/dev.nix
.idx/icon.png
.modified
.stylelintrc.json
apphosting.yaml
components.json
docs/blueprint.md
next.config.ts
package.json
postcss.config.cjs
postcss.config.mjs
README.md
scripts/checkFirestore.ts
scripts/list_models.mjs
src/ai/dev.ts
src/ai/flows/management-trust-score.ts
src/ai/flows/portfolio-impact-of-macro-events.ts
src/ai/flows/regulatory-watch.ts
src/ai/flows/summarize-risk-factors.ts
src/ai/utils.ts
src/ai/vertex.ts
src/app/actions.ts
src/app/api/documents/route.ts
src/app/api/insights/route.ts
src/app/api/portfolios/route.ts
src/app/dashboard/page.tsx
src/app/favicon.ico
src/app/globals.css
src/app/layout.tsx
src/app/macro-simulation/page.tsx
src/app/management-trust/page.tsx
src/app/page.tsx
src/app/regulatory-watch/page.tsx
src/app/risk-analysis/page.tsx
src/app/setup/page.tsx
src/components/features/macro-shock-simulator.tsx
src/components/features/management-trust-score.tsx
src/components/features/portfolio-drawdown-chart.tsx
src/components/features/portfolio-setup-form.tsx
src/components/features/regulatory-watch.tsx
src/components/features/risk-factor-summary.tsx
src/components/layout/app-layout.tsx
src/components/layout/header.tsx
src/components/ui/accordion.tsx
src/components/ui/alert-dialog.tsx
src/components/ui/alert.tsx
src/components/ui/avatar.tsx
src/components/ui/badge.tsx
src/components/ui/button.tsx
src/components/ui/calendar.tsx
src/components/ui/card.tsx
src/components/ui/carousel.tsx
src/components/ui/chart.tsx
src/components/ui/checkbox.tsx
src/components/ui/collapsible.tsx
src/components/ui/dialog.tsx
src/components/ui/dropdown-menu.tsx
src/components/ui/form.tsx
src/components/ui/input.tsx
src/components/ui/label.tsx
src/components/ui/menubar.tsx
src/components/ui/popover.tsx
src/components/ui/progress.tsx
src/components/ui/radio-group.tsx
src/components/ui/scroll-area.tsx
src/components/ui/select.tsx
src/components/ui/separator.tsx
src/components/ui/sheet.tsx
src/components/ui/sidebar.tsx
src/components/ui/skeleton.tsx
src/components/ui/slider.tsx
src/components/ui/switch.tsx
src/components/ui/table.tsx
src/components/ui/tabs.tsx
src/components/ui/textarea.tsx
src/components/ui/toast.tsx
src/components/ui/toaster.tsx
src/components/ui/tooltip.tsx
src/hooks/use-mobile.tsx
src/hooks/use-toast.ts
src/lib/aiCache.ts
src/lib/companies.ts
src/lib/firestoreAdmin.ts
src/lib/gcs.ts
src/lib/logging.ts
src/lib/placeholder-images.json
src/lib/placeholder-images.ts
src/lib/portfolio.ts
src/lib/tavily.ts
src/lib/utils.ts
src/types/portfolio.ts
src/types/vertexai.d.ts
tailwind.config.cjs
tailwind.config.ts
tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".stylelintrc.json">
{
  "rules": {
    "at-rule-no-unknown": [true, {
      "ignoreAtRules": [
        "tailwind",
        "apply",
        "variants",
        "responsive",
        "screen",
        "layer",
        "content"
      ]
    }]
  }
}
</file>

<file path="postcss.config.cjs">
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
};
</file>

<file path="scripts/checkFirestore.ts">
import { getFirestore } from '@/lib/firestoreAdmin';

async function main() {
  const db = getFirestore();
  const snapshot = await db.collection('portfolios').get();
  if (snapshot.empty) {
    console.log('No portfolios found.');
  } else {
    snapshot.forEach(doc => {
      console.log(doc.id, '=>', doc.data());
    });
  }
}

main().catch(console.error);
</file>

<file path="scripts/list_models.mjs">
import dotenv from 'dotenv';
dotenv.config({ path: '.env.local' });

const apiKey = process.env.GOOGLE_API_KEY;
if (!apiKey) {
  console.error('Missing GOOGLE_API_KEY in env');
  process.exit(1);
}

const url = `https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`;

async function listModels() {
  const res = await fetch(url);
  if (!res.ok) {
    const body = await res.text();
    console.error('Error listing models', res.status, body);
    process.exit(1);
  }
  const data = await res.json();
  console.log(JSON.stringify(data, null, 2));
}

listModels().catch(err => { console.error(err); process.exit(1); });
</file>

<file path="src/ai/utils.ts">
export function extractJsonFromText(text: string): string | null {
  if (!text) return null;
  let t = text.trim();

  // Remove code fences and common wrappers
  t = t.replace(/^```(?:json)?\s*/i, '').replace(/\s*```$/i, '').trim();
  t = t.replace(/^`+|`+$/g, '').trim();
  t = t.replace(/^json\s*/i, '').trim();

  // Quick parse attempt
  try { JSON.parse(t); return t; } catch (e) { /* fallthrough */ }

  // Find first JSON opener and match braces/brackets to extract a balanced JSON substring
  const start = t.search(/[\{\[]/);
  if (start === -1) return null;
  const openChar = t[start];
  const closeChar = openChar === '{' ? '}' : ']';
  let depth = 0;
  for (let i = start; i < t.length; i++) {
    const ch = t[i];
    if (ch === openChar) depth++;
    else if (ch === closeChar) depth--;

    if (depth === 0) {
      const candidate = t.slice(start, i + 1);
      try { JSON.parse(candidate); return candidate; } catch (e) { break; }
    }
  }

  return null;
}
</file>

<file path="src/app/api/documents/route.ts">
import { NextResponse } from 'next/server';
import { uploadDocumentToGCS, saveDocumentMetadata } from '@/lib/gcs';

export async function POST(req: Request) {
  try {
    const json = await req.json();
    const { portfolioId, filename, contentType, dataBase64 } = json;
    if (!filename || !dataBase64) return NextResponse.json({ error: 'filename and dataBase64 are required' }, { status: 400 });

    const buffer = Buffer.from(dataBase64, 'base64');
    const destPath = `documents/${portfolioId ?? 'unassigned'}/${Date.now()}-${filename}`;
    const upload = await uploadDocumentToGCS(destPath, buffer, contentType || 'application/octet-stream');

    const docId = await saveDocumentMetadata({ portfolioId, filename, contentType: contentType || 'application/octet-stream', gcsPath: `gs://${upload.bucket}/${upload.path}`, size: upload.size });

    return NextResponse.json({ ok: true, docId, gcsPath: `gs://${upload.bucket}/${upload.path}` });
  } catch (e: any) {
    return NextResponse.json({ error: e.message || 'Unknown error' }, { status: 500 });
  }
}
</file>

<file path="src/app/api/insights/route.ts">
import { NextResponse } from 'next/server';
import { generateForTask } from '@/ai/vertex';

export async function POST(req: Request) {
  try {
    const body = await req.json();
    const { task, input } = body;
    if (!task) return NextResponse.json({ error: 'task is required' }, { status: 400 });

    const text = await generateForTask(task, input);
    // Return the raw generated text as JSON. Client can parse as needed.
    return NextResponse.json({ text });
  } catch (e: any) {
    console.error(e);
    return NextResponse.json({ error: e.message || 'Unknown error' }, { status: 500 });
  }
}
</file>

<file path="src/app/api/portfolios/route.ts">
import { NextResponse } from 'next/server';
import { getFirestore } from '@/lib/firestoreAdmin';
import { Portfolio } from '@/types/portfolio';
import { initializeApp, getApps } from 'firebase-admin/app';

// Initialize Firebase Admin using Application Default Credentials (only if not already initialized)
if (getApps().length === 0) {
  initializeApp();
}

export async function POST(req: Request) {
  try {
    const body = await req.json();
    const { name, holdings } = body;
    if (!name || !Array.isArray(holdings)) {
      return NextResponse.json({ error: 'name and holdings are required' }, { status: 400 });
    }

    const db = getFirestore();
    const now = new Date().toISOString();
    const docRef = db.collection('portfolios').doc();
    const portfolio: Portfolio = {
      id: docRef.id,
      name,
      holdings: holdings.map((h: any) => ({
        companyId: h.companyId,
        quantity: Number(h.quantity || 0),
        avgPrice: Number(h.avgPrice || 0),
      })),
      createdAt: now,
    };

    await docRef.set(portfolio);

    return NextResponse.json({ portfolio });
  } catch (e: any) {
    console.error(e);
    return NextResponse.json({ error: e.message || 'Unknown error' }, { status: 500 });
  }
}
</file>

<file path="src/app/setup/page.tsx">
import { getCompanies } from '@/lib/companies';
import React from 'react';
import PortfolioSetupForm from '@/components/features/portfolio-setup-form';

// Simple server component that fetches companies and renders a client form
export default async function SetupPage() {
  const companies = await getCompanies();
  return (
    <div className="max-w-3xl mx-auto py-12">
      <h1 className="text-2xl font-semibold mb-4">Initial Portfolio Setup</h1>
      <p className="text-sm text-muted-foreground mb-6">Add your holdings to construct a portfolio. This will be used across the dashboard.</p>
      {/* server -> client prop */}
      <PortfolioSetupForm companies={companies} />
    </div>
  );
}
</file>

<file path="src/components/features/portfolio-setup-form.tsx">
'use client';
import React, { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { useRouter } from 'next/navigation';

export default function PortfolioSetupForm({ companies }: { companies: any[] }) {
  const router = useRouter();
  const [rows, setRows] = useState([{ companyId: companies[0]?.id || '', quantity: '', avgPrice: '' }]);
  const [name, setName] = useState('My Portfolio');

  function updateRow(idx: number, patch: Partial<any>) {
    const copy = [...rows];
    copy[idx] = { ...copy[idx], ...patch };
    setRows(copy);
  }

  function addRow() {
    setRows([...rows, { companyId: companies[0]?.id || '', quantity: '', avgPrice: '' }]);
  }

  function removeRow(idx: number) {
    setRows(rows.filter((_, i) => i !== idx));
  }

  async function submit() {
    const holdings = rows.map((r) => ({ companyId: r.companyId, quantity: Number(r.quantity), avgPrice: Number(r.avgPrice) }));
    const res = await fetch('/api/portfolios', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name, holdings }) });
    const json = await res.json();
    if (res.ok && json.portfolio) {
      const id = json.portfolio.id;
      router.push(`/dashboard?portfolioId=${id}`);
    } else {
      alert(json.error || 'Failed to create portfolio');
    }
  }

  return (
    <div className="space-y-4">
      <div>
        <label className="block text-sm font-medium mb-1">Portfolio Name</label>
        <Input value={name} onChange={(e) => setName(e.target.value)} />
      </div>
      {rows.map((r, idx) => (
        <div key={idx} className="grid grid-cols-3 gap-2 items-end">
          <div>
            <label className="block text-sm font-medium mb-1">Company</label>
            <Select value={r.companyId} onValueChange={(v) => updateRow(idx, { companyId: v })}>
              <SelectTrigger>
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                {companies.map((c) => (
                  <SelectItem value={c.id} key={c.id}>{c.name}</SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">Quantity</label>
            <Input value={r.quantity} onChange={(e) => updateRow(idx, { quantity: e.target.value })} />
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">Avg Price</label>
            <Input value={r.avgPrice} onChange={(e) => updateRow(idx, { avgPrice: e.target.value })} />
          </div>
          <div className="col-span-3 flex gap-2">
            <Button variant="ghost" onClick={() => removeRow(idx)}>Remove</Button>
          </div>
        </div>
      ))}
      <div className="flex gap-2">
        <Button variant="outline" onClick={addRow}>Add Holding</Button>
        <Button onClick={submit}>Create Portfolio</Button>
      </div>
    </div>
  );
}
</file>

<file path="src/lib/aiCache.ts">
import { getFirestore } from './firestoreAdmin';
import crypto from 'crypto';
import { logStructured } from './logging';

const collectionName = 'ai_cache';
const DEFAULT_TTL_SECONDS = Number(process.env.AI_CACHE_TTL_SECONDS ?? 60 * 60 * 24); // 24h default

function hashInput(input: any) {
  try {
    return crypto.createHash('sha256').update(JSON.stringify(input)).digest('hex');
  } catch (e) {
    return String(input);
  }
}

export async function getCachedResult(analysisType: string, opts: { portfolioId?: string; input?: any }) {
  const db = getFirestore();
  const keyParts = [analysisType];
  if (opts.portfolioId) keyParts.push(`portfolio:${opts.portfolioId}`);
  if (opts.input) keyParts.push(`input:${hashInput(opts.input)}`);
  const docId = keyParts.join('|');

  const doc = await db.collection(collectionName).doc(docId).get();
  if (!doc.exists) return null;

  const data = doc.data();
  if (!data) return null;

  const created = data.createdAt ? new Date(data.createdAt) : null;
  if (created) {
    const ageSec = (Date.now() - created.getTime()) / 1000;
    if (ageSec > DEFAULT_TTL_SECONDS) {
      logStructured('INFO', 'AI cache expired', { analysisType, portfolioId: opts.portfolioId, docId });
      // stale
      return null;
    }
  }

  logStructured('INFO', 'AI cache hit', { analysisType, portfolioId: opts.portfolioId, docId });
  return data as { resultJson: string; model?: string; latencyMs?: number; createdAt?: string };
}

export async function setCachedResult(analysisType: string, opts: { portfolioId?: string; input?: any; resultJson: string; model?: string; latencyMs?: number }) {
  const db = getFirestore();
  const keyParts = [analysisType];
  if (opts.portfolioId) keyParts.push(`portfolio:${opts.portfolioId}`);
  if (opts.input) keyParts.push(`input:${hashInput(opts.input)}`);
  const docId = keyParts.join('|');

  const payload = {
    analysisType,
    portfolioId: opts.portfolioId ?? null,
    inputHash: opts.input ? hashInput(opts.input) : null,
    resultJson: opts.resultJson,
    model: opts.model ?? null,
    latencyMs: opts.latencyMs ?? null,
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString(),
  };

  await db.collection(collectionName).doc(docId).set(payload);
  logStructured('INFO', 'AI cache set', { analysisType, portfolioId: opts.portfolioId, docId, latencyMs: opts.latencyMs });
}
</file>

<file path="src/lib/companies.ts">
import { getFirestore } from './firestoreAdmin';
import { Company } from '@/types/portfolio';
import { logStructured } from './logging';

let cache: { ts: number; companies: Company[] } | null = null;
const CACHE_TTL = 1000 * 60 * 5; // 5 minutes

export async function getCompanies(): Promise<Company[]> {
  if (cache && Date.now() - cache.ts < CACHE_TTL) return cache.companies;

  // Try to fetch from Firestore; if it fails (credentials, missing file, etc.), fall back to an in-memory seed.
    let db: any;
    try {
      db = getFirestore();
    } catch (e) {
      db = null;
    }

    // If Firestore is unavailable, always return seed data
    const seed: Company[] = [
      { id: 'reliance', name: 'Reliance Industries', ticker: 'RELIANCE.NS', sector: 'Energy' },
      { id: 'hdfcbank', name: 'HDFC Bank', ticker: 'HDFCBANK.NS', sector: 'Financials' },
      { id: 'infosys', name: 'Infosys', ticker: 'INFY.NS', sector: 'Technology' },
    ];

    if (!db) {
      cache = { ts: Date.now(), companies: seed };
      return seed;
    }

    try {
      const snapshot = await db.collection('companies').get();
      if (!snapshot.empty) {
        const companies = snapshot.docs.map((d: any) => ({ id: d.id, ...(d.data() as any) } as Company));
        cache = { ts: Date.now(), companies };
        return companies;
      }

      // Seed with a few example companies if none exist
      if (db.batch) {
        const batch = db.batch();
        seed.forEach((c) => {
          const ref = db.collection('companies').doc(c.id);
          batch.set(ref, { name: c.name, ticker: c.ticker, sector: c.sector });
        });
        await batch.commit();
      }
      cache = { ts: Date.now(), companies: seed };
      return seed;
    } catch (e) {
      cache = { ts: Date.now(), companies: seed };
      return seed;
    }
}

export async function getCompanyById(id: string): Promise<Company | null> {
  if (cache) {
    const found = cache.companies.find((c) => c.id === id);
    if (found) return found;
  }

  try {
    const db = getFirestore();
    const doc = await db.collection('companies').doc(id).get();
    if (!doc.exists) return null;
    return { id: doc.id, ...(doc.data() as any) } as Company;
  } catch (e: any) {
    logStructured('WARN', 'Could not fetch single company from Firestore; falling back to cached seed', { id, error: e.message });
    if (cache) return cache.companies.find((c) => c.id === id) ?? null;
    return null;
  }
}

export async function isFirestoreAvailable(): Promise<boolean> {
  try {
    const db = getFirestore();
    await db.collection('companies').limit(1).get();
    return true;
  } catch (e) {
    return false;
  }
}
</file>

<file path="src/lib/firestoreAdmin.ts">
import admin from 'firebase-admin';

function initAdmin(): admin.app.App {
  if (admin.apps.length) return admin.apps[0] as admin.app.App;

  const projectId = process.env.FIREBASE_PROJECT_ID || process.env.GCP_PROJECT_ID;
  const clientEmail = process.env.FIREBASE_CLIENT_EMAIL;
  let privateKey = process.env.FIREBASE_PRIVATE_KEY;

  if (!projectId) {
    throw new Error('FIREBASE_PROJECT_ID or GCP_PROJECT_ID is not set in env');
  }

  if (!privateKey || !clientEmail) {
    // Fall back to Application Default Credentials
    try {
      return admin.initializeApp({ projectId });
    } catch (e) {
      throw new Error('Failed to initialize Firebase Admin: ' + (e as Error).message);
    }
  }

  // Handle multiline private key
  privateKey = privateKey.replace(/\\n/g, '\n');

  return admin.initializeApp({
    credential: admin.credential.cert({ projectId, clientEmail, privateKey }),
  });
}

export function getFirestore() {
  try {
    initAdmin();
    return admin.firestore();
  } catch (e) {
    throw e;
  }
}
</file>

<file path="src/lib/gcs.ts">
import { Storage } from '@google-cloud/storage';
import { getFirestore } from './firestoreAdmin';
import { logStructured } from './logging';

const DEFAULT_BUCKET = process.env.GCS_BUCKET_NAME;

function getStorageClient() {
  if (!DEFAULT_BUCKET) throw new Error('GCS_BUCKET_NAME not set in env');
  return new Storage();
}

export async function uploadDocumentToGCS(path: string, buffer: Buffer, contentType: string) {
  const bucketName = DEFAULT_BUCKET;
  if (!bucketName) throw new Error('GCS_BUCKET_NAME is not configured in environment');

  const storage = getStorageClient();
  const bucket = storage.bucket(bucketName as string);
  const file = bucket.file(path);

  await file.save(buffer, { contentType });
  // Make object private by default
  await file.makePrivate();

  const meta = await file.getMetadata();
  logStructured('INFO', 'Uploaded document to GCS', { bucket: bucketName, path, size: meta?.[0]?.size });
  return { bucket: bucketName, path, size: Number(meta?.[0]?.size ?? 0), updated: meta?.[0]?.updated };
}

export async function saveDocumentMetadata(metadata: { portfolioId?: string; filename: string; contentType: string; gcsPath: string; size: number; uploadedBy?: string | null }) {
  const db = getFirestore();
  const docRef = await db.collection('documents').add({
    ...metadata,
    createdAt: new Date().toISOString(),
  });

  logStructured('INFO', 'Saved document metadata', { docId: docRef.id, filename: metadata.filename, portfolioId: metadata.portfolioId });
  return docRef.id;
}
</file>

<file path="src/lib/logging.ts">
type LogLevel = 'INFO' | 'WARN' | 'ERROR' | 'DEBUG';

export function logStructured(level: LogLevel, message: string, meta: Record<string, any> = {}) {
  // Emit a single-line JSON log to keep it compatible with structured logging systems.
  const entry = {
    timestamp: new Date().toISOString(),
    severity: level,
    message,
    ...meta,
  };
  // Keep using console for now; swap to Google Cloud Logging later by replacing this implementation.
  try {
    console.log(JSON.stringify(entry));
  } catch (e) {
    // Fallback if circular structures sneak in
    console.log(JSON.stringify({ ...entry, meta: JSON.stringify(meta) }));
  }
}
</file>

<file path="src/lib/portfolio.ts">
import { getFirestore } from './firestoreAdmin';
import { Portfolio } from '@/types/portfolio';

let cache: { ts: number; portfolios: Record<string, Portfolio> } | null = null;
const CACHE_TTL = 1000 * 60 * 1; // 1 minute

export async function getPortfolioById(id: string): Promise<Portfolio | null> {
  if (!id) return null;
  if (cache && Date.now() - cache.ts < CACHE_TTL && cache.portfolios[id]) return cache.portfolios[id];
  const db = getFirestore();
  const doc = await db.collection('portfolios').doc(id).get();
  if (!doc.exists) return null;
  const data = doc.data() as Portfolio;
  data.id = doc.id;
  cache = cache || { ts: Date.now(), portfolios: {} };
  cache.ts = Date.now();
  cache.portfolios[id] = data;
  return data;
}

export function portfolioHoldingsToText(portfolio: Portfolio) {
  // Convert holdings to a string e.g., 'Reliance: 20 shares @ 2300, HDFC Bank: 10 shares @ 1200'
  if (!portfolio) return '';
  return portfolio.holdings.map((h) => `${h.companyId}: ${h.quantity} shares @ ${h.avgPrice}`).join(', ');
}
</file>

<file path="src/lib/tavily.ts">
/**
 * Tavily API integration for real-time company search and insights
 * Documentation: https://docs.tavily.com
 */

export interface TavilySearchResult {
  title: string;
  url: string;
  content: string;
  published_date?: string;
  score?: number;
}

export interface TavilySearchResponse {
  query: string;
  response_time: number;
  answer?: string;
  images?: string[];
  follow_up_questions?: string[];
  results: TavilySearchResult[];
}

/**
 * Search for company information using Tavily API
 * @param companyName - The name of the company to search for
 * @param maxResults - Maximum number of results to return (default: 5)
 * @returns Tavily search results including news, insights, and relevant information
 */
export async function searchCompany(
  companyName: string,
  maxResults: number = 5
): Promise<TavilySearchResponse> {
  const apiKey = process.env.TAVILY_API_KEY;
  
  if (!apiKey) {
    throw new Error('TAVILY_API_KEY environment variable is not set. Please add it to your .env.local file.');
  }

  const response = await fetch('https://api.tavily.com/search', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      api_key: apiKey,
      query: `${companyName} company news insights financial analysis`,
      search_depth: 'advanced',
      include_answer: true,
      include_images: false,
      include_raw_content: false,
      max_results: maxResults,
      include_domains: [],
      exclude_domains: [],
    }),
  });

  if (!response.ok) {
    const errorText = await response.text();
    throw new Error(`Tavily API error (${response.status}): ${errorText}`);
  }

  const data = await response.json() as TavilySearchResponse;
  return data;
}

/**
 * Search for multiple companies and aggregate results
 * @param companyNames - Array of company names to search for
 * @param maxResultsPerCompany - Maximum results per company (default: 3)
 * @returns Map of company name to search results
 */
export async function searchMultipleCompanies(
  companyNames: string[],
  maxResultsPerCompany: number = 3
): Promise<Map<string, TavilySearchResponse>> {
  const results = new Map<string, TavilySearchResponse>();
  
  // Search all companies in parallel
  const searchPromises = companyNames.map(async (companyName) => {
    try {
      const searchResults = await searchCompany(companyName, maxResultsPerCompany);
      return { companyName, searchResults };
    } catch (error) {
      console.error(`Error searching for ${companyName}:`, error);
      // Return empty results on error
      return {
        companyName,
        searchResults: {
          query: companyName,
          response_time: 0,
          results: [],
        } as TavilySearchResponse,
      };
    }
  });

  const allSearchResults = await Promise.all(searchPromises);
  
  for (const { companyName, searchResults } of allSearchResults) {
    results.set(companyName, searchResults);
  }

  return results;
}

/**
 * Format Tavily search results into a context string for AI models
 * @param companyName - Name of the company
 * @param searchResults - Tavily search results
 * @returns Formatted string with company insights
 */
export function formatTavilyResultsForAI(
  companyName: string,
  searchResults: TavilySearchResponse
): string {
  let context = `\n\n=== Real-time Information for ${companyName} ===\n`;
  
  if (searchResults.answer) {
    context += `Summary: ${searchResults.answer}\n\n`;
  }

  if (searchResults.results && searchResults.results.length > 0) {
    context += `Recent News and Insights:\n`;
    searchResults.results.forEach((result, index) => {
      context += `${index + 1}. ${result.title}\n`;
      context += `   Source: ${result.url}\n`;
      if (result.published_date) {
        context += `   Date: ${result.published_date}\n`;
      }
      context += `   Content: ${result.content.substring(0, 300)}${result.content.length > 300 ? '...' : ''}\n\n`;
    });
  }

  if (searchResults.follow_up_questions && searchResults.follow_up_questions.length > 0) {
    context += `\nRelated Questions: ${searchResults.follow_up_questions.join(', ')}\n`;
  }

  return context;
}

/**
 * Extract company names from portfolio holdings text
 * @param holdingsText - Text describing portfolio holdings
 * @returns Array of company names/tickers
 */
export function extractCompanyNames(holdingsText: string): string[] {
  // Extract company names from text like "RELIANCE: 20%, HDFCBANK: 15%, INFY: 10%"
  // or "Reliance: 20 shares @ 2300, HDFC Bank: 10 shares @ 1200"
  const patterns = [
    /([A-Z][A-Z0-9]+):/g, // Ticker format: RELIANCE:, HDFCBANK:
    /([A-Z][a-zA-Z\s]+?):/g, // Company name format: Reliance Industries:, HDFC Bank:
  ];

  const companies = new Set<string>();
  
  for (const pattern of patterns) {
    const matches = holdingsText.matchAll(pattern);
    for (const match of matches) {
      const companyName = match[1].trim();
      if (companyName.length > 1) {
        companies.add(companyName);
      }
    }
  }

  return Array.from(companies);
}
</file>

<file path="src/types/portfolio.ts">
export type Company = {
  id: string;
  name: string;
  ticker?: string;
  sector?: string;
  metadata?: Record<string, any>;
};

export type Holding = {
  companyId: string;
  quantity: number;
  avgPrice: number; // per-share average price in portfolio currency
};

export type Portfolio = {
  id: string;
  name: string;
  ownerId?: string;
  holdings: Holding[];
  createdAt: string; // ISO
  updatedAt?: string;
};
</file>

<file path="src/types/vertexai.d.ts">
declare module '@google-cloud/vertexai' {
  export class VertexAI {
    constructor(opts?: { projectId?: string });
    getModel(name: string): {
      generate: (opts: {
        input?: string;
        temperature?: number;
        maxOutputTokens?: number;
      }) => Promise<any>;
    };
  }
  export default VertexAI;
}
</file>

<file path="tailwind.config.cjs">
module.exports = {
  content: [
    "./src/**/*.{js,ts,jsx,tsx}",
    "./app/**/*.{js,ts,jsx,tsx}",
    "./pages/**/*.{js,ts,jsx,tsx}"
  ],
  theme: {
    extend: {},
  },
  plugins: [],
  darkMode: "class",
};
</file>

<file path=".idx/dev.nix">
# To learn more about how to use Nix to configure your environment
# see: https://firebase.google.com/docs/studio/customize-workspace
{pkgs}: {
  # Which nixpkgs channel to use.
  channel = "stable-24.11"; # or "unstable"
  # Use https://search.nixos.org/packages to find packages
  packages = [
    pkgs.nodejs_20
    pkgs.zulu
  ];
  # Sets environment variables in the workspace
  env = {};
  # This adds a file watcher to startup the firebase emulators. The emulators will only start if
  # a firebase.json file is written into the user's directory
  services.firebase.emulators = {
    # Disabling because we are using prod backends right now
    detect = false;
    projectId = "demo-app";
    services = ["auth" "firestore"];
  };
  idx = {
    # Search for the extensions you want on https://open-vsx.org/ and use "publisher.id"
    extensions = [
      # "vscodevim.vim"
    ];
    workspace = {
      onCreate = {
        default.openFiles = [
          "src/app/page.tsx"
        ];
      };
    };
    # Enable previews and customize configuration
    previews = {
      enable = true;
      previews = {
        web = {
          command = ["npm" "run" "dev" "--" "--port" "$PORT" "--hostname" "0.0.0.0"];
          manager = "web";
        };
      };
    };
  };
}
</file>

<file path=".modified">

</file>

<file path="apphosting.yaml">
# Settings to manage and configure a Firebase App Hosting backend.
# https://firebase.google.com/docs/app-hosting/configure

runConfig:
  # Increase this value if you'd like to automatically spin up
  # more instances in response to increased traffic.
  maxInstances: 1
</file>

<file path="components.json">
{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "default",
  "rsc": true,
  "tsx": true,
  "tailwind": {
    "config": "tailwind.config.ts",
    "css": "src/app/globals.css",
    "baseColor": "neutral",
    "cssVariables": true,
    "prefix": ""
  },
  "aliases": {
    "components": "@/components",
    "utils": "@/lib/utils",
    "ui": "@/components/ui",
    "lib": "@/lib",
    "hooks": "@/hooks"
  },
  "iconLibrary": "lucide"
}
</file>

<file path="docs/blueprint.md">
# **App Name**: ClearFinanceAI

## Core Features:

- Management Commitment Tracker: Analyze earnings call transcripts, annual reports, and filings to identify, track, and score management's commitments vs. actual performance, calculating a Management Trust Score.
- Macro-Shock Simulation Tool: Simulate the portfolio-level impact of macro events (RBI rate hike, oil shock, etc.) using probabilistic reasoning, estimating drawdown, sector sensitivity, and downside risk.
- Traceable Insights: Provide sentence-level citations hyperlinked to original sources (filings, transcripts) for every insight, ensuring transparency and auditability.
- Long-Horizon Analysis: Enable reasoning across multi-year financial histories to identify long-term trends and patterns, avoiding short-term noise, as a 'tool' to inform forecasts.
- Portfolio Drawdown Visualization: Display expected portfolio drawdown and sector-wise sensitivity in a clear, interactive chart.
- Risk Factor Summary: Provide a concise summary of key risk factors identified from financial documents, categorized and weighted by potential impact.

## Style Guidelines:

- Primary color: Deep indigo (#4B0082) for a sense of institutional rigor, long-term stability, and transparency.
- Background color: Very light gray (#F0F0F0), a desaturated near-white in the same hue family as indigo. Suitable for a light color scheme.
- Accent color: Teal (#008080), an analogous color with slightly different saturation for calls to action and interactive elements.
- Body and headline font: 'Inter' for a modern, objective, neutral feel, suitable for financial reporting.
- Use clean, minimalist icons to represent financial concepts and data points.
- Prioritize a clean and structured layout for easy readability and data comprehension.
- Subtle transitions and animations to enhance user engagement without distracting from the data.
</file>

<file path="postcss.config.mjs">
/** @type {import('postcss-load-config').Config} */
const config = {
  plugins: {
    tailwindcss: {},
  },
};

export default config;
</file>

<file path="README.md">
Clear Finance uses a Firebase-first, serverless architecture with a React + TypeScript single-page frontend. Structured financial data is stored in Firestore and visualized deterministically through charts, while Google Gemini (Vertex AI) is used only for qualitative financial explanations. The system prioritizes simplicity, low operational overhead, and clear separation between numeric certainty and AI interpretation.
</file>

<file path="src/ai/vertex.ts">
import { extractJsonFromText } from './utils';

export async function generateForTask(task: string, input: any): Promise<string> {
  const apiKey = process.env.GOOGLE_API_KEY || process.env.NEXT_PUBLIC_GOOGLE_API_KEY;
  
  if (!apiKey) {
    throw new Error('GOOGLE_API_KEY environment variable is not set.');
  }

  let prompt = '';
  switch (task) {
    case 'managementTrustScore': {
      prompt = `You are Clear Finance, an AI-first forensic intelligence engine. Calculate a management trust score based on the following company data. Make sure the output is ONLY valid JSON (no backticks, no markdown).`;
      break;
    }
    case 'macroShock': {
      prompt = `You are Clear Finance, an AI-first forensic intelligence engine. Simulate the impact of the following macro shock on a portfolio. Use the real-time company data provided (if available) to make more accurate predictions.

REQUIRED OUTPUT FIELDS (all must be present as strings):
- expectedDrawdown: e.g., "8-12%" or "15% to 20%"
- downsideRisk: e.g., "High risk" or "Moderate (10-15%)" or "Low to moderate downside exposure"
- sectorSensitivity: Description of which sectors are most affected
- reasoning: Detailed analysis explaining the impact

Make sure the output is ONLY valid JSON (no backticks, no markdown).`;
      break;
    }
    case 'riskAnalysis': {
      prompt = `You are Clear Finance, an AI-first forensic intelligence engine. Analyze the following financial document for risks. Make sure the output is ONLY valid JSON (no backticks, no markdown).`;
      break;
    }
    case 'regulatoryWatch': {
      prompt = `You are Clear Finance, an AI-first forensic intelligence engine. Scan the following regulatory filing for red flags. Make sure the output is ONLY valid JSON (no backticks, no markdown).`;
      break;
    }
    default: {
      prompt = `Process the following input: ${JSON.stringify(input)}`;
    }
  }

  // Include Tavily context if available (for macroShock task)
  if (task === 'macroShock' && (input as any).tavilyContext) {
    prompt += `\n\n${(input as any).tavilyContext}`;
    // Remove tavilyContext from JSON input to avoid duplication
    const { tavilyContext, ...inputWithoutTavily } = input as any;
    prompt += `\n\nInput: ${JSON.stringify(inputWithoutTavily)}`;
  } else {
    prompt += `\n\nInput: ${JSON.stringify(input)}`;
  }

  // Helper: try to extract a valid JSON string from model output
  function extractJsonFromText(text: string): string | null {
    if (!text) return null;
    let t = text.trim();

    // Remove code fences and common wrappers
    t = t.replace(/^```(?:json)?\s*/i, '').replace(/\s*```$/i, '').trim();
    t = t.replace(/^`+|`+$/g, '').trim();
    t = t.replace(/^json\s*/i, '').trim();

    // Quick parse attempt
    try { JSON.parse(t); return t; } catch (e) { /* fallthrough */ }

    // Find first JSON opener and match braces/brackets to extract a balanced JSON substring
    const start = t.search(/[\{\[]/);
    if (start === -1) return null;
    const openChar = t[start];
    const closeChar = openChar === '{' ? '}' : ']';
    let depth = 0;
    for (let i = start; i < t.length; i++) {
      const ch = t[i];
      if (ch === openChar) depth++;
      else if (ch === closeChar) depth--;

      if (depth === 0) {
        const candidate = t.slice(start, i + 1);
        try { JSON.parse(candidate); return candidate; } catch (e) { break; }
      }
    }

    return null;
  }

  // Use Google AI API (Gemini) with API key instead of Vertex AI
  const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-flash-latest:generateContent?key=${apiKey}`;

  async function callModel(bodyPrompt: string, temperature = 0.7) {
    const { logStructured } = await import('@/lib/logging');
    const start = Date.now();

    const res = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        contents: [{ parts: [{ text: bodyPrompt }] }],
        generationConfig: {
          temperature,
          maxOutputTokens: 4096,
        }
      })
    });

    const latencyMs = Date.now() - start;

    if (!res.ok) {
      const errText = await res.text();
      logStructured('ERROR', 'Google AI API error', { status: res.status, latencyMs });
      throw new Error(`Google AI API error (${res.status}): ${errText}`);
    }

    const json = await res.json();
    const text = json.candidates?.[0]?.content?.parts?.[0]?.text || '';

    logStructured('INFO', 'Google AI API call completed', { task, latencyMs, model: process.env.GEMINI_MODEL || 'gemini-flash-latest' });

    return text;
  }

  // First attempt
  const raw = await callModel(prompt, 0.7);
  const extracted = extractJsonFromText(raw);
  if (extracted) return extracted;

  // Retry with stricter instruction and low temperature
  const retryPrompt = `${prompt}\n\nIMPORTANT: Respond with ONLY valid JSON — no markdown, no code fences, and no explanatory text. If you cannot produce valid JSON, return an empty object: {}.`;
  const retryRaw = await callModel(retryPrompt, 0.0);
  const retryExtracted = extractJsonFromText(retryRaw);
  if (retryExtracted) return retryExtracted;

  // Return the original raw text if we couldn't extract valid JSON — caller will handle parse errors
  return raw || retryRaw || '';
}

export const ai = { generateForTask };
</file>

<file path="src/components/ui/accordion.tsx">
"use client"

import * as React from "react"
import * as AccordionPrimitive from "@radix-ui/react-accordion"
import { ChevronDown } from "lucide-react"

import { cn } from "@/lib/utils"

const Accordion = AccordionPrimitive.Root

const AccordionItem = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>
>(({ className, ...props }, ref) => (
  <AccordionPrimitive.Item
    ref={ref}
    className={cn("border-b", className)}
    {...props}
  />
))
AccordionItem.displayName = "AccordionItem"

const AccordionTrigger = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <AccordionPrimitive.Header className="flex">
    <AccordionPrimitive.Trigger
      ref={ref}
      className={cn(
        "flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180",
        className
      )}
      {...props}
    >
      {children}
      <ChevronDown className="h-4 w-4 shrink-0 transition-transform duration-200" />
    </AccordionPrimitive.Trigger>
  </AccordionPrimitive.Header>
))
AccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName

const AccordionContent = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <AccordionPrimitive.Content
    ref={ref}
    className="overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down"
    {...props}
  >
    <div className={cn("pb-4 pt-0", className)}>{children}</div>
  </AccordionPrimitive.Content>
))

AccordionContent.displayName = AccordionPrimitive.Content.displayName

export { Accordion, AccordionItem, AccordionTrigger, AccordionContent }
</file>

<file path="src/components/ui/alert-dialog.tsx">
"use client"

import * as React from "react"
import * as AlertDialogPrimitive from "@radix-ui/react-alert-dialog"

import { cn } from "@/lib/utils"
import { buttonVariants } from "@/components/ui/button"

const AlertDialog = AlertDialogPrimitive.Root

const AlertDialogTrigger = AlertDialogPrimitive.Trigger

const AlertDialogPortal = AlertDialogPrimitive.Portal

const AlertDialogOverlay = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Overlay
    className={cn(
      "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
    ref={ref}
  />
))
AlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName

const AlertDialogContent = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>
>(({ className, ...props }, ref) => (
  <AlertDialogPortal>
    <AlertDialogOverlay />
    <AlertDialogPrimitive.Content
      ref={ref}
      className={cn(
        "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",
        className
      )}
      {...props}
    />
  </AlertDialogPortal>
))
AlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName

const AlertDialogHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-2 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
AlertDialogHeader.displayName = "AlertDialogHeader"

const AlertDialogFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
AlertDialogFooter.displayName = "AlertDialogFooter"

const AlertDialogTitle = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Title
    ref={ref}
    className={cn("text-lg font-semibold", className)}
    {...props}
  />
))
AlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName

const AlertDialogDescription = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
AlertDialogDescription.displayName =
  AlertDialogPrimitive.Description.displayName

const AlertDialogAction = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Action>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Action
    ref={ref}
    className={cn(buttonVariants(), className)}
    {...props}
  />
))
AlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName

const AlertDialogCancel = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Cancel
    ref={ref}
    className={cn(
      buttonVariants({ variant: "outline" }),
      "mt-2 sm:mt-0",
      className
    )}
    {...props}
  />
))
AlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName

export {
  AlertDialog,
  AlertDialogPortal,
  AlertDialogOverlay,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogFooter,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogAction,
  AlertDialogCancel,
}
</file>

<file path="src/components/ui/alert.tsx">
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const alertVariants = cva(
  "relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground",
  {
    variants: {
      variant: {
        default: "bg-background text-foreground",
        destructive:
          "border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

const Alert = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>
>(({ className, variant, ...props }, ref) => (
  <div
    ref={ref}
    role="alert"
    className={cn(alertVariants({ variant }), className)}
    {...props}
  />
))
Alert.displayName = "Alert"

const AlertTitle = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLHeadingElement>
>(({ className, ...props }, ref) => (
  <h5
    ref={ref}
    className={cn("mb-1 font-medium leading-none tracking-tight", className)}
    {...props}
  />
))
AlertTitle.displayName = "AlertTitle"

const AlertDescription = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("text-sm [&_p]:leading-relaxed", className)}
    {...props}
  />
))
AlertDescription.displayName = "AlertDescription"

export { Alert, AlertTitle, AlertDescription }
</file>

<file path="src/components/ui/avatar.tsx">
"use client"

import * as React from "react"
import * as AvatarPrimitive from "@radix-ui/react-avatar"

import { cn } from "@/lib/utils"

const Avatar = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Root
    ref={ref}
    className={cn(
      "relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",
      className
    )}
    {...props}
  />
))
Avatar.displayName = AvatarPrimitive.Root.displayName

const AvatarImage = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Image>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Image
    ref={ref}
    className={cn("aspect-square h-full w-full", className)}
    {...props}
  />
))
AvatarImage.displayName = AvatarPrimitive.Image.displayName

const AvatarFallback = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Fallback>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Fallback
    ref={ref}
    className={cn(
      "flex h-full w-full items-center justify-center rounded-full bg-muted",
      className
    )}
    {...props}
  />
))
AvatarFallback.displayName = AvatarPrimitive.Fallback.displayName

export { Avatar, AvatarImage, AvatarFallback }
</file>

<file path="src/components/ui/badge.tsx">
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const badgeVariants = cva(
  "inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary text-primary-foreground hover:bg-primary/80",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",
        destructive:
          "border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",
        outline: "text-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

export interface BadgeProps
  extends React.HTMLAttributes<HTMLDivElement>,
    VariantProps<typeof badgeVariants> {}

function Badge({ className, variant, ...props }: BadgeProps) {
  return (
    <div className={cn(badgeVariants({ variant }), className)} {...props} />
  )
}

export { Badge, badgeVariants }
</file>

<file path="src/components/ui/button.tsx">
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
  {
    variants: {
      variant: {
        default: "bg-primary text-primary-foreground hover:bg-primary/90",
        destructive:
          "bg-destructive text-destructive-foreground hover:bg-destructive/90",
        outline:
          "border border-input bg-background hover:bg-accent hover:text-accent-foreground",
        secondary:
          "bg-secondary text-secondary-foreground hover:bg-secondary/80",
        ghost: "hover:bg-accent hover:text-accent-foreground",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-10 px-4 py-2",
        sm: "h-9 rounded-md px-3",
        lg: "h-11 rounded-md px-8",
        icon: "h-10 w-10",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {
  asChild?: boolean
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant, size, asChild = false, ...props }, ref) => {
    const Comp = asChild ? Slot : "button"
    return (
      <Comp
        className={cn(buttonVariants({ variant, size, className }))}
        ref={ref}
        {...props}
      />
    )
  }
)
Button.displayName = "Button"

export { Button, buttonVariants }
</file>

<file path="src/components/ui/card.tsx">
import * as React from "react"

import { cn } from "@/lib/utils"

const Card = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "rounded-lg border bg-card text-card-foreground shadow-sm",
      className
    )}
    {...props}
  />
))
Card.displayName = "Card"

const CardHeader = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex flex-col space-y-1.5 p-6", className)}
    {...props}
  />
))
CardHeader.displayName = "CardHeader"

const CardTitle = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "text-2xl font-semibold leading-none tracking-tight",
      className
    )}
    {...props}
  />
))
CardTitle.displayName = "CardTitle"

const CardDescription = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
CardDescription.displayName = "CardDescription"

const CardContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />
))
CardContent.displayName = "CardContent"

const CardFooter = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex items-center p-6 pt-0", className)}
    {...props}
  />
))
CardFooter.displayName = "CardFooter"

export { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }
</file>

<file path="src/components/ui/carousel.tsx">
"use client"

import * as React from "react"
import useEmblaCarousel, {
  type UseEmblaCarouselType,
} from "embla-carousel-react"
import { ArrowLeft, ArrowRight } from "lucide-react"

import { cn } from "@/lib/utils"
import { Button } from "@/components/ui/button"

type CarouselApi = UseEmblaCarouselType[1]
type UseCarouselParameters = Parameters<typeof useEmblaCarousel>
type CarouselOptions = UseCarouselParameters[0]
type CarouselPlugin = UseCarouselParameters[1]

type CarouselProps = {
  opts?: CarouselOptions
  plugins?: CarouselPlugin
  orientation?: "horizontal" | "vertical"
  setApi?: (api: CarouselApi) => void
}

type CarouselContextProps = {
  carouselRef: ReturnType<typeof useEmblaCarousel>[0]
  api: ReturnType<typeof useEmblaCarousel>[1]
  scrollPrev: () => void
  scrollNext: () => void
  canScrollPrev: boolean
  canScrollNext: boolean
} & CarouselProps

const CarouselContext = React.createContext<CarouselContextProps | null>(null)

function useCarousel() {
  const context = React.useContext(CarouselContext)

  if (!context) {
    throw new Error("useCarousel must be used within a <Carousel />")
  }

  return context
}

const Carousel = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement> & CarouselProps
>(
  (
    {
      orientation = "horizontal",
      opts,
      setApi,
      plugins,
      className,
      children,
      ...props
    },
    ref
  ) => {
    const [carouselRef, api] = useEmblaCarousel(
      {
        ...opts,
        axis: orientation === "horizontal" ? "x" : "y",
      },
      plugins
    )
    const [canScrollPrev, setCanScrollPrev] = React.useState(false)
    const [canScrollNext, setCanScrollNext] = React.useState(false)

    const onSelect = React.useCallback((api: CarouselApi) => {
      if (!api) {
        return
      }

      setCanScrollPrev(api.canScrollPrev())
      setCanScrollNext(api.canScrollNext())
    }, [])

    const scrollPrev = React.useCallback(() => {
      api?.scrollPrev()
    }, [api])

    const scrollNext = React.useCallback(() => {
      api?.scrollNext()
    }, [api])

    const handleKeyDown = React.useCallback(
      (event: React.KeyboardEvent<HTMLDivElement>) => {
        if (event.key === "ArrowLeft") {
          event.preventDefault()
          scrollPrev()
        } else if (event.key === "ArrowRight") {
          event.preventDefault()
          scrollNext()
        }
      },
      [scrollPrev, scrollNext]
    )

    React.useEffect(() => {
      if (!api || !setApi) {
        return
      }

      setApi(api)
    }, [api, setApi])

    React.useEffect(() => {
      if (!api) {
        return
      }

      onSelect(api)
      api.on("reInit", onSelect)
      api.on("select", onSelect)

      return () => {
        api?.off("select", onSelect)
      }
    }, [api, onSelect])

    return (
      <CarouselContext.Provider
        value={{
          carouselRef,
          api: api,
          opts,
          orientation:
            orientation || (opts?.axis === "y" ? "vertical" : "horizontal"),
          scrollPrev,
          scrollNext,
          canScrollPrev,
          canScrollNext,
        }}
      >
        <div
          ref={ref}
          onKeyDownCapture={handleKeyDown}
          className={cn("relative", className)}
          role="region"
          aria-roledescription="carousel"
          {...props}
        >
          {children}
        </div>
      </CarouselContext.Provider>
    )
  }
)
Carousel.displayName = "Carousel"

const CarouselContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => {
  const { carouselRef, orientation } = useCarousel()

  return (
    <div ref={carouselRef} className="overflow-hidden">
      <div
        ref={ref}
        className={cn(
          "flex",
          orientation === "horizontal" ? "-ml-4" : "-mt-4 flex-col",
          className
        )}
        {...props}
      />
    </div>
  )
})
CarouselContent.displayName = "CarouselContent"

const CarouselItem = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => {
  const { orientation } = useCarousel()

  return (
    <div
      ref={ref}
      role="group"
      aria-roledescription="slide"
      className={cn(
        "min-w-0 shrink-0 grow-0 basis-full",
        orientation === "horizontal" ? "pl-4" : "pt-4",
        className
      )}
      {...props}
    />
  )
})
CarouselItem.displayName = "CarouselItem"

const CarouselPrevious = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<typeof Button>
>(({ className, variant = "outline", size = "icon", ...props }, ref) => {
  const { orientation, scrollPrev, canScrollPrev } = useCarousel()

  return (
    <Button
      ref={ref}
      variant={variant}
      size={size}
      className={cn(
        "absolute  h-8 w-8 rounded-full",
        orientation === "horizontal"
          ? "-left-12 top-1/2 -translate-y-1/2"
          : "-top-12 left-1/2 -translate-x-1/2 rotate-90",
        className
      )}
      disabled={!canScrollPrev}
      onClick={scrollPrev}
      {...props}
    >
      <ArrowLeft className="h-4 w-4" />
      <span className="sr-only">Previous slide</span>
    </Button>
  )
})
CarouselPrevious.displayName = "CarouselPrevious"

const CarouselNext = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<typeof Button>
>(({ className, variant = "outline", size = "icon", ...props }, ref) => {
  const { orientation, scrollNext, canScrollNext } = useCarousel()

  return (
    <Button
      ref={ref}
      variant={variant}
      size={size}
      className={cn(
        "absolute h-8 w-8 rounded-full",
        orientation === "horizontal"
          ? "-right-12 top-1/2 -translate-y-1/2"
          : "-bottom-12 left-1/2 -translate-x-1/2 rotate-90",
        className
      )}
      disabled={!canScrollNext}
      onClick={scrollNext}
      {...props}
    >
      <ArrowRight className="h-4 w-4" />
      <span className="sr-only">Next slide</span>
    </Button>
  )
})
CarouselNext.displayName = "CarouselNext"

export {
  type CarouselApi,
  Carousel,
  CarouselContent,
  CarouselItem,
  CarouselPrevious,
  CarouselNext,
}
</file>

<file path="src/components/ui/checkbox.tsx">
"use client"

import * as React from "react"
import * as CheckboxPrimitive from "@radix-ui/react-checkbox"
import { Check } from "lucide-react"

import { cn } from "@/lib/utils"

const Checkbox = React.forwardRef<
  React.ElementRef<typeof CheckboxPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>
>(({ className, ...props }, ref) => (
  <CheckboxPrimitive.Root
    ref={ref}
    className={cn(
      "peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",
      className
    )}
    {...props}
  >
    <CheckboxPrimitive.Indicator
      className={cn("flex items-center justify-center text-current")}
    >
      <Check className="h-4 w-4" />
    </CheckboxPrimitive.Indicator>
  </CheckboxPrimitive.Root>
))
Checkbox.displayName = CheckboxPrimitive.Root.displayName

export { Checkbox }
</file>

<file path="src/components/ui/collapsible.tsx">
"use client"

import * as CollapsiblePrimitive from "@radix-ui/react-collapsible"

const Collapsible = CollapsiblePrimitive.Root

const CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger

const CollapsibleContent = CollapsiblePrimitive.CollapsibleContent

export { Collapsible, CollapsibleTrigger, CollapsibleContent }
</file>

<file path="src/components/ui/dialog.tsx">
"use client"

import * as React from "react"
import * as DialogPrimitive from "@radix-ui/react-dialog"
import { X } from "lucide-react"

import { cn } from "@/lib/utils"

const Dialog = DialogPrimitive.Root

const DialogTrigger = DialogPrimitive.Trigger

const DialogPortal = DialogPrimitive.Portal

const DialogClose = DialogPrimitive.Close

const DialogOverlay = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Overlay
    ref={ref}
    className={cn(
      "fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
  />
))
DialogOverlay.displayName = DialogPrimitive.Overlay.displayName

const DialogContent = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <DialogPortal>
    <DialogOverlay />
    <DialogPrimitive.Content
      ref={ref}
      className={cn(
        "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",
        className
      )}
      {...props}
    >
      {children}
      <DialogPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground">
        <X className="h-4 w-4" />
        <span className="sr-only">Close</span>
      </DialogPrimitive.Close>
    </DialogPrimitive.Content>
  </DialogPortal>
))
DialogContent.displayName = DialogPrimitive.Content.displayName

const DialogHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-1.5 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
DialogHeader.displayName = "DialogHeader"

const DialogFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
DialogFooter.displayName = "DialogFooter"

const DialogTitle = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Title
    ref={ref}
    className={cn(
      "text-lg font-semibold leading-none tracking-tight",
      className
    )}
    {...props}
  />
))
DialogTitle.displayName = DialogPrimitive.Title.displayName

const DialogDescription = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
DialogDescription.displayName = DialogPrimitive.Description.displayName

export {
  Dialog,
  DialogPortal,
  DialogOverlay,
  DialogClose,
  DialogTrigger,
  DialogContent,
  DialogHeader,
  DialogFooter,
  DialogTitle,
  DialogDescription,
}
</file>

<file path="src/components/ui/dropdown-menu.tsx">
"use client"

import * as React from "react"
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu"
import { Check, ChevronRight, Circle } from "lucide-react"

import { cn } from "@/lib/utils"

const DropdownMenu = DropdownMenuPrimitive.Root

const DropdownMenuTrigger = DropdownMenuPrimitive.Trigger

const DropdownMenuGroup = DropdownMenuPrimitive.Group

const DropdownMenuPortal = DropdownMenuPrimitive.Portal

const DropdownMenuSub = DropdownMenuPrimitive.Sub

const DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup

const DropdownMenuSubTrigger = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {
    inset?: boolean
  }
>(({ className, inset, children, ...props }, ref) => (
  <DropdownMenuPrimitive.SubTrigger
    ref={ref}
    className={cn(
      "flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
      inset && "pl-8",
      className
    )}
    {...props}
  >
    {children}
    <ChevronRight className="ml-auto" />
  </DropdownMenuPrimitive.SubTrigger>
))
DropdownMenuSubTrigger.displayName =
  DropdownMenuPrimitive.SubTrigger.displayName

const DropdownMenuSubContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.SubContent
    ref={ref}
    className={cn(
      "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
      className
    )}
    {...props}
  />
))
DropdownMenuSubContent.displayName =
  DropdownMenuPrimitive.SubContent.displayName

const DropdownMenuContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
  <DropdownMenuPrimitive.Portal>
    <DropdownMenuPrimitive.Content
      ref={ref}
      sideOffset={sideOffset}
      className={cn(
        "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className
      )}
      {...props}
    />
  </DropdownMenuPrimitive.Portal>
))
DropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName

const DropdownMenuItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
DropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName

const DropdownMenuCheckboxItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>
>(({ className, children, checked, ...props }, ref) => (
  <DropdownMenuPrimitive.CheckboxItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    checked={checked}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.CheckboxItem>
))
DropdownMenuCheckboxItem.displayName =
  DropdownMenuPrimitive.CheckboxItem.displayName

const DropdownMenuRadioItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>
>(({ className, children, ...props }, ref) => (
  <DropdownMenuPrimitive.RadioItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <Circle className="h-2 w-2 fill-current" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.RadioItem>
))
DropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName

const DropdownMenuLabel = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Label
    ref={ref}
    className={cn(
      "px-2 py-1.5 text-sm font-semibold",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
DropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName

const DropdownMenuSeparator = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props}
  />
))
DropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName

const DropdownMenuShortcut = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLSpanElement>) => {
  return (
    <span
      className={cn("ml-auto text-xs tracking-widest opacity-60", className)}
      {...props}
    />
  )
}
DropdownMenuShortcut.displayName = "DropdownMenuShortcut"

export {
  DropdownMenu,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuGroup,
  DropdownMenuPortal,
  DropdownMenuSub,
  DropdownMenuSubContent,
  DropdownMenuSubTrigger,
  DropdownMenuRadioGroup,
}
</file>

<file path="src/components/ui/form.tsx">
"use client"

import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"
import { Slot } from "@radix-ui/react-slot"
import {
  Controller,
  FormProvider,
  useFormContext,
  type ControllerProps,
  type FieldPath,
  type FieldValues,
} from "react-hook-form"

import { cn } from "@/lib/utils"
import { Label } from "@/components/ui/label"

const Form = FormProvider

type FormFieldContextValue<
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>
> = {
  name: TName
}

const FormFieldContext = React.createContext<FormFieldContextValue>(
  {} as FormFieldContextValue
)

const FormField = <
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>
>({
  ...props
}: ControllerProps<TFieldValues, TName>) => {
  return (
    <FormFieldContext.Provider value={{ name: props.name }}>
      <Controller {...props} />
    </FormFieldContext.Provider>
  )
}

const useFormField = () => {
  const fieldContext = React.useContext(FormFieldContext)
  const itemContext = React.useContext(FormItemContext)
  const { getFieldState, formState } = useFormContext()

  const fieldState = getFieldState(fieldContext.name, formState)

  if (!fieldContext) {
    throw new Error("useFormField should be used within <FormField>")
  }

  const { id } = itemContext

  return {
    id,
    name: fieldContext.name,
    formItemId: `${id}-form-item`,
    formDescriptionId: `${id}-form-item-description`,
    formMessageId: `${id}-form-item-message`,
    ...fieldState,
  }
}

type FormItemContextValue = {
  id: string
}

const FormItemContext = React.createContext<FormItemContextValue>(
  {} as FormItemContextValue
)

const FormItem = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => {
  const id = React.useId()

  return (
    <FormItemContext.Provider value={{ id }}>
      <div ref={ref} className={cn("space-y-2", className)} {...props} />
    </FormItemContext.Provider>
  )
})
FormItem.displayName = "FormItem"

const FormLabel = React.forwardRef<
  React.ElementRef<typeof LabelPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>
>(({ className, ...props }, ref) => {
  const { error, formItemId } = useFormField()

  return (
    <Label
      ref={ref}
      className={cn(error && "text-destructive", className)}
      htmlFor={formItemId}
      {...props}
    />
  )
})
FormLabel.displayName = "FormLabel"

const FormControl = React.forwardRef<
  React.ElementRef<typeof Slot>,
  React.ComponentPropsWithoutRef<typeof Slot>
>(({ ...props }, ref) => {
  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()

  return (
    <Slot
      ref={ref}
      id={formItemId}
      aria-describedby={
        !error
          ? `${formDescriptionId}`
          : `${formDescriptionId} ${formMessageId}`
      }
      aria-invalid={!!error}
      {...props}
    />
  )
})
FormControl.displayName = "FormControl"

const FormDescription = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, ...props }, ref) => {
  const { formDescriptionId } = useFormField()

  return (
    <p
      ref={ref}
      id={formDescriptionId}
      className={cn("text-sm text-muted-foreground", className)}
      {...props}
    />
  )
})
FormDescription.displayName = "FormDescription"

const FormMessage = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, children, ...props }, ref) => {
  const { error, formMessageId } = useFormField()
  const body = error ? String(error?.message ?? "") : children

  if (!body) {
    return null
  }

  return (
    <p
      ref={ref}
      id={formMessageId}
      className={cn("text-sm font-medium text-destructive", className)}
      {...props}
    >
      {body}
    </p>
  )
})
FormMessage.displayName = "FormMessage"

export {
  useFormField,
  Form,
  FormItem,
  FormLabel,
  FormControl,
  FormDescription,
  FormMessage,
  FormField,
}
</file>

<file path="src/components/ui/input.tsx">
import * as React from "react"

import { cn } from "@/lib/utils"

const Input = React.forwardRef<HTMLInputElement, React.ComponentProps<"input">>(
  ({ className, type, ...props }, ref) => {
    return (
      <input
        type={type}
        className={cn(
          "flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
          className
        )}
        ref={ref}
        {...props}
      />
    )
  }
)
Input.displayName = "Input"

export { Input }
</file>

<file path="src/components/ui/label.tsx">
"use client"

import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const labelVariants = cva(
  "text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"
)

const Label = React.forwardRef<
  React.ElementRef<typeof LabelPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &
    VariantProps<typeof labelVariants>
>(({ className, ...props }, ref) => (
  <LabelPrimitive.Root
    ref={ref}
    className={cn(labelVariants(), className)}
    {...props}
  />
))
Label.displayName = LabelPrimitive.Root.displayName

export { Label }
</file>

<file path="src/components/ui/menubar.tsx">
"use client"

import * as React from "react"
import * as MenubarPrimitive from "@radix-ui/react-menubar"
import { Check, ChevronRight, Circle } from "lucide-react"

import { cn } from "@/lib/utils"

function MenubarMenu({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {
  return <MenubarPrimitive.Menu {...props} />
}

function MenubarGroup({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Group>) {
  return <MenubarPrimitive.Group {...props} />
}

function MenubarPortal({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {
  return <MenubarPrimitive.Portal {...props} />
}

function MenubarRadioGroup({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {
  return <MenubarPrimitive.RadioGroup {...props} />
}

function MenubarSub({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {
  return <MenubarPrimitive.Sub data-slot="menubar-sub" {...props} />
}

const Menubar = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>
>(({ className, ...props }, ref) => (
  <MenubarPrimitive.Root
    ref={ref}
    className={cn(
      "flex h-10 items-center space-x-1 rounded-md border bg-background p-1",
      className
    )}
    {...props}
  />
))
Menubar.displayName = MenubarPrimitive.Root.displayName

const MenubarTrigger = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>
>(({ className, ...props }, ref) => (
  <MenubarPrimitive.Trigger
    ref={ref}
    className={cn(
      "flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground",
      className
    )}
    {...props}
  />
))
MenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName

const MenubarSubTrigger = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {
    inset?: boolean
  }
>(({ className, inset, children, ...props }, ref) => (
  <MenubarPrimitive.SubTrigger
    ref={ref}
    className={cn(
      "flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground",
      inset && "pl-8",
      className
    )}
    {...props}
  >
    {children}
    <ChevronRight className="ml-auto h-4 w-4" />
  </MenubarPrimitive.SubTrigger>
))
MenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName

const MenubarSubContent = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.SubContent>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>
>(({ className, ...props }, ref) => (
  <MenubarPrimitive.SubContent
    ref={ref}
    className={cn(
      "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
      className
    )}
    {...props}
  />
))
MenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName

const MenubarContent = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>
>(
  (
    { className, align = "start", alignOffset = -4, sideOffset = 8, ...props },
    ref
  ) => (
    <MenubarPrimitive.Portal>
      <MenubarPrimitive.Content
        ref={ref}
        align={align}
        alignOffset={alignOffset}
        sideOffset={sideOffset}
        className={cn(
          "z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
          className
        )}
        {...props}
      />
    </MenubarPrimitive.Portal>
  )
)
MenubarContent.displayName = MenubarPrimitive.Content.displayName

const MenubarItem = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <MenubarPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
MenubarItem.displayName = MenubarPrimitive.Item.displayName

const MenubarCheckboxItem = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>
>(({ className, children, checked, ...props }, ref) => (
  <MenubarPrimitive.CheckboxItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    checked={checked}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <MenubarPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </MenubarPrimitive.ItemIndicator>
    </span>
    {children}
  </MenubarPrimitive.CheckboxItem>
))
MenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName

const MenubarRadioItem = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.RadioItem>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>
>(({ className, children, ...props }, ref) => (
  <MenubarPrimitive.RadioItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <MenubarPrimitive.ItemIndicator>
        <Circle className="h-2 w-2 fill-current" />
      </MenubarPrimitive.ItemIndicator>
    </span>
    {children}
  </MenubarPrimitive.RadioItem>
))
MenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName

const MenubarLabel = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <MenubarPrimitive.Label
    ref={ref}
    className={cn(
      "px-2 py-1.5 text-sm font-semibold",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
MenubarLabel.displayName = MenubarPrimitive.Label.displayName

const MenubarSeparator = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <MenubarPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props}
  />
))
MenubarSeparator.displayName = MenubarPrimitive.Separator.displayName

const MenubarShortcut = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLSpanElement>) => {
  return (
    <span
      className={cn(
        "ml-auto text-xs tracking-widest text-muted-foreground",
        className
      )}
      {...props}
    />
  )
}
MenubarShortcut.displayname = "MenubarShortcut"

export {
  Menubar,
  MenubarMenu,
  MenubarTrigger,
  MenubarContent,
  MenubarItem,
  MenubarSeparator,
  MenubarLabel,
  MenubarCheckboxItem,
  MenubarRadioGroup,
  MenubarRadioItem,
  MenubarPortal,
  MenubarSubContent,
  MenubarSubTrigger,
  MenubarGroup,
  MenubarSub,
  MenubarShortcut,
}
</file>

<file path="src/components/ui/popover.tsx">
"use client"

import * as React from "react"
import * as PopoverPrimitive from "@radix-ui/react-popover"

import { cn } from "@/lib/utils"

const Popover = PopoverPrimitive.Root

const PopoverTrigger = PopoverPrimitive.Trigger

const PopoverContent = React.forwardRef<
  React.ElementRef<typeof PopoverPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>
>(({ className, align = "center", sideOffset = 4, ...props }, ref) => (
  <PopoverPrimitive.Portal>
    <PopoverPrimitive.Content
      ref={ref}
      align={align}
      sideOffset={sideOffset}
      className={cn(
        "z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className
      )}
      {...props}
    />
  </PopoverPrimitive.Portal>
))
PopoverContent.displayName = PopoverPrimitive.Content.displayName

export { Popover, PopoverTrigger, PopoverContent }
</file>

<file path="src/components/ui/progress.tsx">
"use client"

import * as React from "react"
import * as ProgressPrimitive from "@radix-ui/react-progress"

import { cn } from "@/lib/utils"

const Progress = React.forwardRef<
  React.ElementRef<typeof ProgressPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>
>(({ className, value, ...props }, ref) => (
  <ProgressPrimitive.Root
    ref={ref}
    className={cn(
      "relative h-4 w-full overflow-hidden rounded-full bg-secondary",
      className
    )}
    {...props}
  >
    <ProgressPrimitive.Indicator
      className="h-full w-full flex-1 bg-primary transition-all"
      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}
    />
  </ProgressPrimitive.Root>
))
Progress.displayName = ProgressPrimitive.Root.displayName

export { Progress }
</file>

<file path="src/components/ui/radio-group.tsx">
"use client"

import * as React from "react"
import * as RadioGroupPrimitive from "@radix-ui/react-radio-group"
import { Circle } from "lucide-react"

import { cn } from "@/lib/utils"

const RadioGroup = React.forwardRef<
  React.ElementRef<typeof RadioGroupPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>
>(({ className, ...props }, ref) => {
  return (
    <RadioGroupPrimitive.Root
      className={cn("grid gap-2", className)}
      {...props}
      ref={ref}
    />
  )
})
RadioGroup.displayName = RadioGroupPrimitive.Root.displayName

const RadioGroupItem = React.forwardRef<
  React.ElementRef<typeof RadioGroupPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>
>(({ className, ...props }, ref) => {
  return (
    <RadioGroupPrimitive.Item
      ref={ref}
      className={cn(
        "aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    >
      <RadioGroupPrimitive.Indicator className="flex items-center justify-center">
        <Circle className="h-2.5 w-2.5 fill-current text-current" />
      </RadioGroupPrimitive.Indicator>
    </RadioGroupPrimitive.Item>
  )
})
RadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName

export { RadioGroup, RadioGroupItem }
</file>

<file path="src/components/ui/scroll-area.tsx">
"use client"

import * as React from "react"
import * as ScrollAreaPrimitive from "@radix-ui/react-scroll-area"

import { cn } from "@/lib/utils"

const ScrollArea = React.forwardRef<
  React.ElementRef<typeof ScrollAreaPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>
>(({ className, children, ...props }, ref) => (
  <ScrollAreaPrimitive.Root
    ref={ref}
    className={cn("relative overflow-hidden", className)}
    {...props}
  >
    <ScrollAreaPrimitive.Viewport className="h-full w-full rounded-[inherit]">
      {children}
    </ScrollAreaPrimitive.Viewport>
    <ScrollBar />
    <ScrollAreaPrimitive.Corner />
  </ScrollAreaPrimitive.Root>
))
ScrollArea.displayName = ScrollAreaPrimitive.Root.displayName

const ScrollBar = React.forwardRef<
  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,
  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>
>(({ className, orientation = "vertical", ...props }, ref) => (
  <ScrollAreaPrimitive.ScrollAreaScrollbar
    ref={ref}
    orientation={orientation}
    className={cn(
      "flex touch-none select-none transition-colors",
      orientation === "vertical" &&
        "h-full w-2.5 border-l border-l-transparent p-[1px]",
      orientation === "horizontal" &&
        "h-2.5 flex-col border-t border-t-transparent p-[1px]",
      className
    )}
    {...props}
  >
    <ScrollAreaPrimitive.ScrollAreaThumb className="relative flex-1 rounded-full bg-border" />
  </ScrollAreaPrimitive.ScrollAreaScrollbar>
))
ScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName

export { ScrollArea, ScrollBar }
</file>

<file path="src/components/ui/select.tsx">
"use client"

import * as React from "react"
import * as SelectPrimitive from "@radix-ui/react-select"
import { Check, ChevronDown, ChevronUp } from "lucide-react"

import { cn } from "@/lib/utils"

const Select = SelectPrimitive.Root

const SelectGroup = SelectPrimitive.Group

const SelectValue = SelectPrimitive.Value

const SelectTrigger = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Trigger
    ref={ref}
    className={cn(
      "flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",
      className
    )}
    {...props}
  >
    {children}
    <SelectPrimitive.Icon asChild>
      <ChevronDown className="h-4 w-4 opacity-50" />
    </SelectPrimitive.Icon>
  </SelectPrimitive.Trigger>
))
SelectTrigger.displayName = SelectPrimitive.Trigger.displayName

const SelectScrollUpButton = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.ScrollUpButton
    ref={ref}
    className={cn(
      "flex cursor-default items-center justify-center py-1",
      className
    )}
    {...props}
  >
    <ChevronUp className="h-4 w-4" />
  </SelectPrimitive.ScrollUpButton>
))
SelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName

const SelectScrollDownButton = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.ScrollDownButton
    ref={ref}
    className={cn(
      "flex cursor-default items-center justify-center py-1",
      className
    )}
    {...props}
  >
    <ChevronDown className="h-4 w-4" />
  </SelectPrimitive.ScrollDownButton>
))
SelectScrollDownButton.displayName =
  SelectPrimitive.ScrollDownButton.displayName

const SelectContent = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>
>(({ className, children, position = "popper", ...props }, ref) => (
  <SelectPrimitive.Portal>
    <SelectPrimitive.Content
      ref={ref}
      className={cn(
        "relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        position === "popper" &&
          "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
        className
      )}
      position={position}
      {...props}
    >
      <SelectScrollUpButton />
      <SelectPrimitive.Viewport
        className={cn(
          "p-1",
          position === "popper" &&
            "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"
        )}
      >
        {children}
      </SelectPrimitive.Viewport>
      <SelectScrollDownButton />
    </SelectPrimitive.Content>
  </SelectPrimitive.Portal>
))
SelectContent.displayName = SelectPrimitive.Content.displayName

const SelectLabel = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.Label
    ref={ref}
    className={cn("py-1.5 pl-8 pr-2 text-sm font-semibold", className)}
    {...props}
  />
))
SelectLabel.displayName = SelectPrimitive.Label.displayName

const SelectItem = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <SelectPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </SelectPrimitive.ItemIndicator>
    </span>

    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
  </SelectPrimitive.Item>
))
SelectItem.displayName = SelectPrimitive.Item.displayName

const SelectSeparator = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props}
  />
))
SelectSeparator.displayName = SelectPrimitive.Separator.displayName

export {
  Select,
  SelectGroup,
  SelectValue,
  SelectTrigger,
  SelectContent,
  SelectLabel,
  SelectItem,
  SelectSeparator,
  SelectScrollUpButton,
  SelectScrollDownButton,
}
</file>

<file path="src/components/ui/separator.tsx">
"use client"

import * as React from "react"
import * as SeparatorPrimitive from "@radix-ui/react-separator"

import { cn } from "@/lib/utils"

const Separator = React.forwardRef<
  React.ElementRef<typeof SeparatorPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>
>(
  (
    { className, orientation = "horizontal", decorative = true, ...props },
    ref
  ) => (
    <SeparatorPrimitive.Root
      ref={ref}
      decorative={decorative}
      orientation={orientation}
      className={cn(
        "shrink-0 bg-border",
        orientation === "horizontal" ? "h-[1px] w-full" : "h-full w-[1px]",
        className
      )}
      {...props}
    />
  )
)
Separator.displayName = SeparatorPrimitive.Root.displayName

export { Separator }
</file>

<file path="src/components/ui/sheet.tsx">
"use client"

import * as React from "react"
import * as SheetPrimitive from "@radix-ui/react-dialog"
import { cva, type VariantProps } from "class-variance-authority"
import { X } from "lucide-react"

import { cn } from "@/lib/utils"

const Sheet = SheetPrimitive.Root

const SheetTrigger = SheetPrimitive.Trigger

const SheetClose = SheetPrimitive.Close

const SheetPortal = SheetPrimitive.Portal

const SheetOverlay = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Overlay
    className={cn(
      "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
    ref={ref}
  />
))
SheetOverlay.displayName = SheetPrimitive.Overlay.displayName

const sheetVariants = cva(
  "fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500",
  {
    variants: {
      side: {
        top: "inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top",
        bottom:
          "inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom",
        left: "inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm",
        right:
          "inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm",
      },
    },
    defaultVariants: {
      side: "right",
    },
  }
)

interface SheetContentProps
  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,
    VariantProps<typeof sheetVariants> {}

const SheetContent = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Content>,
  SheetContentProps
>(({ side = "right", className, children, ...props }, ref) => (
  <SheetPortal>
    <SheetOverlay />
    <SheetPrimitive.Content
      ref={ref}
      className={cn(sheetVariants({ side }), className)}
      {...props}
    >
      {children}
      <SheetPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary">
        <X className="h-4 w-4" />
        <span className="sr-only">Close</span>
      </SheetPrimitive.Close>
    </SheetPrimitive.Content>
  </SheetPortal>
))
SheetContent.displayName = SheetPrimitive.Content.displayName

const SheetHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-2 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
SheetHeader.displayName = "SheetHeader"

const SheetFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
SheetFooter.displayName = "SheetFooter"

const SheetTitle = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Title
    ref={ref}
    className={cn("text-lg font-semibold text-foreground", className)}
    {...props}
  />
))
SheetTitle.displayName = SheetPrimitive.Title.displayName

const SheetDescription = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
SheetDescription.displayName = SheetPrimitive.Description.displayName

export {
  Sheet,
  SheetPortal,
  SheetOverlay,
  SheetTrigger,
  SheetClose,
  SheetContent,
  SheetHeader,
  SheetFooter,
  SheetTitle,
  SheetDescription,
}
</file>

<file path="src/components/ui/skeleton.tsx">
import { cn } from "@/lib/utils"

function Skeleton({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) {
  return (
    <div
      className={cn("animate-pulse rounded-md bg-muted", className)}
      {...props}
    />
  )
}

export { Skeleton }
</file>

<file path="src/components/ui/slider.tsx">
"use client"

import * as React from "react"
import * as SliderPrimitive from "@radix-ui/react-slider"

import { cn } from "@/lib/utils"

const Slider = React.forwardRef<
  React.ElementRef<typeof SliderPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>
>(({ className, ...props }, ref) => (
  <SliderPrimitive.Root
    ref={ref}
    className={cn(
      "relative flex w-full touch-none select-none items-center",
      className
    )}
    {...props}
  >
    <SliderPrimitive.Track className="relative h-2 w-full grow overflow-hidden rounded-full bg-secondary">
      <SliderPrimitive.Range className="absolute h-full bg-primary" />
    </SliderPrimitive.Track>
    <SliderPrimitive.Thumb className="block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50" />
  </SliderPrimitive.Root>
))
Slider.displayName = SliderPrimitive.Root.displayName

export { Slider }
</file>

<file path="src/components/ui/switch.tsx">
"use client"

import * as React from "react"
import * as SwitchPrimitives from "@radix-ui/react-switch"

import { cn } from "@/lib/utils"

const Switch = React.forwardRef<
  React.ElementRef<typeof SwitchPrimitives.Root>,
  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>
>(({ className, ...props }, ref) => (
  <SwitchPrimitives.Root
    className={cn(
      "peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input",
      className
    )}
    {...props}
    ref={ref}
  >
    <SwitchPrimitives.Thumb
      className={cn(
        "pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0"
      )}
    />
  </SwitchPrimitives.Root>
))
Switch.displayName = SwitchPrimitives.Root.displayName

export { Switch }
</file>

<file path="src/components/ui/table.tsx">
import * as React from "react"

import { cn } from "@/lib/utils"

const Table = React.forwardRef<
  HTMLTableElement,
  React.HTMLAttributes<HTMLTableElement>
>(({ className, ...props }, ref) => (
  <div className="relative w-full overflow-auto">
    <table
      ref={ref}
      className={cn("w-full caption-bottom text-sm", className)}
      {...props}
    />
  </div>
))
Table.displayName = "Table"

const TableHeader = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <thead ref={ref} className={cn("[&_tr]:border-b", className)} {...props} />
))
TableHeader.displayName = "TableHeader"

const TableBody = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <tbody
    ref={ref}
    className={cn("[&_tr:last-child]:border-0", className)}
    {...props}
  />
))
TableBody.displayName = "TableBody"

const TableFooter = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <tfoot
    ref={ref}
    className={cn(
      "border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",
      className
    )}
    {...props}
  />
))
TableFooter.displayName = "TableFooter"

const TableRow = React.forwardRef<
  HTMLTableRowElement,
  React.HTMLAttributes<HTMLTableRowElement>
>(({ className, ...props }, ref) => (
  <tr
    ref={ref}
    className={cn(
      "border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",
      className
    )}
    {...props}
  />
))
TableRow.displayName = "TableRow"

const TableHead = React.forwardRef<
  HTMLTableCellElement,
  React.ThHTMLAttributes<HTMLTableCellElement>
>(({ className, ...props }, ref) => (
  <th
    ref={ref}
    className={cn(
      "h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0",
      className
    )}
    {...props}
  />
))
TableHead.displayName = "TableHead"

const TableCell = React.forwardRef<
  HTMLTableCellElement,
  React.TdHTMLAttributes<HTMLTableCellElement>
>(({ className, ...props }, ref) => (
  <td
    ref={ref}
    className={cn("p-4 align-middle [&:has([role=checkbox])]:pr-0", className)}
    {...props}
  />
))
TableCell.displayName = "TableCell"

const TableCaption = React.forwardRef<
  HTMLTableCaptionElement,
  React.HTMLAttributes<HTMLTableCaptionElement>
>(({ className, ...props }, ref) => (
  <caption
    ref={ref}
    className={cn("mt-4 text-sm text-muted-foreground", className)}
    {...props}
  />
))
TableCaption.displayName = "TableCaption"

export {
  Table,
  TableHeader,
  TableBody,
  TableFooter,
  TableHead,
  TableRow,
  TableCell,
  TableCaption,
}
</file>

<file path="src/components/ui/tabs.tsx">
"use client"

import * as React from "react"
import * as TabsPrimitive from "@radix-ui/react-tabs"

import { cn } from "@/lib/utils"

const Tabs = TabsPrimitive.Root

const TabsList = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.List
    ref={ref}
    className={cn(
      "inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",
      className
    )}
    {...props}
  />
))
TabsList.displayName = TabsPrimitive.List.displayName

const TabsTrigger = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Trigger
    ref={ref}
    className={cn(
      "inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",
      className
    )}
    {...props}
  />
))
TabsTrigger.displayName = TabsPrimitive.Trigger.displayName

const TabsContent = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Content
    ref={ref}
    className={cn(
      "mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
      className
    )}
    {...props}
  />
))
TabsContent.displayName = TabsPrimitive.Content.displayName

export { Tabs, TabsList, TabsTrigger, TabsContent }
</file>

<file path="src/components/ui/textarea.tsx">
import * as React from 'react';

import {cn} from '@/lib/utils';

const Textarea = React.forwardRef<HTMLTextAreaElement, React.ComponentProps<'textarea'>>(
  ({className, ...props}, ref) => {
    return (
      <textarea
        className={cn(
          'flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm',
          className
        )}
        ref={ref}
        {...props}
      />
    );
  }
);
Textarea.displayName = 'Textarea';

export {Textarea};
</file>

<file path="src/components/ui/toast.tsx">
"use client"

import * as React from "react"
import * as ToastPrimitives from "@radix-ui/react-toast"
import { cva, type VariantProps } from "class-variance-authority"
import { X } from "lucide-react"

import { cn } from "@/lib/utils"

const ToastProvider = ToastPrimitives.Provider

const ToastViewport = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Viewport>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Viewport
    ref={ref}
    className={cn(
      "fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]",
      className
    )}
    {...props}
  />
))
ToastViewport.displayName = ToastPrimitives.Viewport.displayName

const toastVariants = cva(
  "group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full",
  {
    variants: {
      variant: {
        default: "border bg-background text-foreground",
        destructive:
          "destructive group border-destructive bg-destructive text-destructive-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

const Toast = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Root>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &
    VariantProps<typeof toastVariants>
>(({ className, variant, ...props }, ref) => {
  return (
    <ToastPrimitives.Root
      ref={ref}
      className={cn(toastVariants({ variant }), className)}
      {...props}
    />
  )
})
Toast.displayName = ToastPrimitives.Root.displayName

const ToastAction = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Action>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Action
    ref={ref}
    className={cn(
      "inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive",
      className
    )}
    {...props}
  />
))
ToastAction.displayName = ToastPrimitives.Action.displayName

const ToastClose = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Close>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Close
    ref={ref}
    className={cn(
      "absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600",
      className
    )}
    toast-close=""
    {...props}
  >
    <X className="h-4 w-4" />
  </ToastPrimitives.Close>
))
ToastClose.displayName = ToastPrimitives.Close.displayName

const ToastTitle = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Title>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Title
    ref={ref}
    className={cn("text-sm font-semibold", className)}
    {...props}
  />
))
ToastTitle.displayName = ToastPrimitives.Title.displayName

const ToastDescription = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Description>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Description
    ref={ref}
    className={cn("text-sm opacity-90", className)}
    {...props}
  />
))
ToastDescription.displayName = ToastPrimitives.Description.displayName

type ToastProps = React.ComponentPropsWithoutRef<typeof Toast>

type ToastActionElement = React.ReactElement<typeof ToastAction>

export {
  type ToastProps,
  type ToastActionElement,
  ToastProvider,
  ToastViewport,
  Toast,
  ToastTitle,
  ToastDescription,
  ToastClose,
  ToastAction,
}
</file>

<file path="src/components/ui/toaster.tsx">
"use client"

import { useToast } from "@/hooks/use-toast"
import {
  Toast,
  ToastClose,
  ToastDescription,
  ToastProvider,
  ToastTitle,
  ToastViewport,
} from "@/components/ui/toast"

export function Toaster() {
  const { toasts } = useToast()

  return (
    <ToastProvider>
      {toasts.map(function ({ id, title, description, action, ...props }) {
        return (
          <Toast key={id} {...props}>
            <div className="grid gap-1">
              {title && <ToastTitle>{title}</ToastTitle>}
              {description && (
                <ToastDescription>{description}</ToastDescription>
              )}
            </div>
            {action}
            <ToastClose />
          </Toast>
        )
      })}
      <ToastViewport />
    </ToastProvider>
  )
}
</file>

<file path="src/components/ui/tooltip.tsx">
"use client"

import * as React from "react"
import * as TooltipPrimitive from "@radix-ui/react-tooltip"

import { cn } from "@/lib/utils"

const TooltipProvider = TooltipPrimitive.Provider

const Tooltip = TooltipPrimitive.Root

const TooltipTrigger = TooltipPrimitive.Trigger

const TooltipContent = React.forwardRef<
  React.ElementRef<typeof TooltipPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
  <TooltipPrimitive.Content
    ref={ref}
    sideOffset={sideOffset}
    className={cn(
      "z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
      className
    )}
    {...props}
  />
))
TooltipContent.displayName = TooltipPrimitive.Content.displayName

export { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }
</file>

<file path="src/hooks/use-mobile.tsx">
import * as React from "react"

const MOBILE_BREAKPOINT = 768

export function useIsMobile() {
  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)

  React.useEffect(() => {
    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)
    const onChange = () => {
      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)
    }
    mql.addEventListener("change", onChange)
    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)
    return () => mql.removeEventListener("change", onChange)
  }, [])

  return !!isMobile
}
</file>

<file path="src/hooks/use-toast.ts">
"use client"

// Inspired by react-hot-toast library
import * as React from "react"

import type {
  ToastActionElement,
  ToastProps,
} from "@/components/ui/toast"

const TOAST_LIMIT = 1
const TOAST_REMOVE_DELAY = 1000000

type ToasterToast = ToastProps & {
  id: string
  title?: React.ReactNode
  description?: React.ReactNode
  action?: ToastActionElement
}

const actionTypes = {
  ADD_TOAST: "ADD_TOAST",
  UPDATE_TOAST: "UPDATE_TOAST",
  DISMISS_TOAST: "DISMISS_TOAST",
  REMOVE_TOAST: "REMOVE_TOAST",
} as const

let count = 0

function genId() {
  count = (count + 1) % Number.MAX_SAFE_INTEGER
  return count.toString()
}

type ActionType = typeof actionTypes

type Action =
  | {
      type: ActionType["ADD_TOAST"]
      toast: ToasterToast
    }
  | {
      type: ActionType["UPDATE_TOAST"]
      toast: Partial<ToasterToast>
    }
  | {
      type: ActionType["DISMISS_TOAST"]
      toastId?: ToasterToast["id"]
    }
  | {
      type: ActionType["REMOVE_TOAST"]
      toastId?: ToasterToast["id"]
    }

interface State {
  toasts: ToasterToast[]
}

const toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()

const addToRemoveQueue = (toastId: string) => {
  if (toastTimeouts.has(toastId)) {
    return
  }

  const timeout = setTimeout(() => {
    toastTimeouts.delete(toastId)
    dispatch({
      type: "REMOVE_TOAST",
      toastId: toastId,
    })
  }, TOAST_REMOVE_DELAY)

  toastTimeouts.set(toastId, timeout)
}

export const reducer = (state: State, action: Action): State => {
  switch (action.type) {
    case "ADD_TOAST":
      return {
        ...state,
        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),
      }

    case "UPDATE_TOAST":
      return {
        ...state,
        toasts: state.toasts.map((t) =>
          t.id === action.toast.id ? { ...t, ...action.toast } : t
        ),
      }

    case "DISMISS_TOAST": {
      const { toastId } = action

      // ! Side effects ! - This could be extracted into a dismissToast() action,
      // but I'll keep it here for simplicity
      if (toastId) {
        addToRemoveQueue(toastId)
      } else {
        state.toasts.forEach((toast) => {
          addToRemoveQueue(toast.id)
        })
      }

      return {
        ...state,
        toasts: state.toasts.map((t) =>
          t.id === toastId || toastId === undefined
            ? {
                ...t,
                open: false,
              }
            : t
        ),
      }
    }
    case "REMOVE_TOAST":
      if (action.toastId === undefined) {
        return {
          ...state,
          toasts: [],
        }
      }
      return {
        ...state,
        toasts: state.toasts.filter((t) => t.id !== action.toastId),
      }
  }
}

const listeners: Array<(state: State) => void> = []

let memoryState: State = { toasts: [] }

function dispatch(action: Action) {
  memoryState = reducer(memoryState, action)
  listeners.forEach((listener) => {
    listener(memoryState)
  })
}

type Toast = Omit<ToasterToast, "id">

function toast({ ...props }: Toast) {
  const id = genId()

  const update = (props: ToasterToast) =>
    dispatch({
      type: "UPDATE_TOAST",
      toast: { ...props, id },
    })
  const dismiss = () => dispatch({ type: "DISMISS_TOAST", toastId: id })

  dispatch({
    type: "ADD_TOAST",
    toast: {
      ...props,
      id,
      open: true,
      onOpenChange: (open) => {
        if (!open) dismiss()
      },
    },
  })

  return {
    id: id,
    dismiss,
    update,
  }
}

function useToast() {
  const [state, setState] = React.useState<State>(memoryState)

  React.useEffect(() => {
    listeners.push(setState)
    return () => {
      const index = listeners.indexOf(setState)
      if (index > -1) {
        listeners.splice(index, 1)
      }
    }
  }, [state])

  return {
    ...state,
    toast,
    dismiss: (toastId?: string) => dispatch({ type: "DISMISS_TOAST", toastId }),
  }
}

export { useToast, toast }
</file>

<file path="src/lib/placeholder-images.ts">
import data from './placeholder-images.json';

export type ImagePlaceholder = {
  id: string;
  description: string;
  imageUrl: string;
  imageHint: string;
};

export const PlaceHolderImages: ImagePlaceholder[] = data.placeholderImages;
</file>

<file path="src/lib/utils.ts">
import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}
</file>

<file path="tailwind.config.ts">
import type {Config} from 'tailwindcss';

export default {
  darkMode: ['class'],
  content: [
    './src/pages/**/*.{js,ts,jsx,tsx,mdx}',
    './src/components/**/*.{js,ts,jsx,tsx,mdx}',
    './src/app/**/*.{js,ts,jsx,tsx,mdx}',
  ],
  theme: {
    extend: {
      fontFamily: {
        body: ['Inter', 'sans-serif'],
        headline: ['Inter', 'sans-serif'],
        code: ['monospace'],
      },
      colors: {
        background: 'hsl(var(--background))',
        foreground: 'hsl(var(--foreground))',
        card: {
          DEFAULT: 'hsl(var(--card))',
          foreground: 'hsl(var(--card-foreground))',
        },
        popover: {
          DEFAULT: 'hsl(var(--popover))',
          foreground: 'hsl(var(--popover-foreground))',
        },
        primary: {
          DEFAULT: 'hsl(var(--primary))',
          foreground: 'hsl(var(--primary-foreground))',
        },
        secondary: {
          DEFAULT: 'hsl(var(--secondary))',
          foreground: 'hsl(var(--secondary-foreground))',
        },
        muted: {
          DEFAULT: 'hsl(var(--muted))',
          foreground: 'hsl(var(--muted-foreground))',
        },
        accent: {
          DEFAULT: 'hsl(var(--accent))',
          foreground: 'hsl(var(--accent-foreground))',
        },
        destructive: {
          DEFAULT: 'hsl(var(--destructive))',
          foreground: 'hsl(var(--destructive-foreground))',
        },
        border: 'hsl(var(--border))',
        input: 'hsl(var(--input))',
        ring: 'hsl(var(--ring))',
        chart: {
          '1': 'hsl(var(--chart-1))',
          '2': 'hsl(var(--chart-2))',
          '3': 'hsl(var(--chart-3))',
          '4': 'hsl(var(--chart-4))',
          '5': 'hsl(var(--chart-5))',
        },
        sidebar: {
          DEFAULT: 'hsl(var(--sidebar-background))',
          foreground: 'hsl(var(--sidebar-foreground))',
          primary: 'hsl(var(--sidebar-primary))',
          'primary-foreground': 'hsl(var(--sidebar-primary-foreground))',
          accent: 'hsl(var(--sidebar-accent))',
          'accent-foreground': 'hsl(var(--sidebar-accent-foreground))',
          border: 'hsl(var(--sidebar-border))',
          ring: 'hsl(var(--sidebar-ring))',
        },
      },
      borderRadius: {
        lg: 'var(--radius)',
        md: 'calc(var(--radius) - 2px)',
        sm: 'calc(var(--radius) - 4px)',
      },
      keyframes: {
        'accordion-down': {
          from: {
            height: '0',
          },
          to: {
            height: 'var(--radix-accordion-content-height)',
          },
        },
        'accordion-up': {
          from: {
            height: 'var(--radix-accordion-content-height)',
          },
          to: {
            height: '0',
          },
        },
      },
      animation: {
        'accordion-down': 'accordion-down 0.2s ease-out',
        'accordion-up': 'accordion-up 0.2s ease-out',
      },
    },
  },
  plugins: [require('tailwindcss-animate')],
} satisfies Config;
</file>

<file path=".gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts

.genkit/*
.env*

# firebase
firebase-debug.log
firestore-debug.log

.env.local
</file>

<file path="next.config.ts">
/* Keep the ESLint and TypeScript build flags: typing as any to avoid NextConfig type mismatch in this dev environment */
const nextConfig: any = {
  /* config options here */
  typescript: {
    ignoreBuildErrors: true,
  },
  eslint: {
    ignoreDuringBuilds: true,
  },
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: 'placehold.co',
        port: '',
        pathname: '/**',
      },
      {
        protocol: 'https',
        hostname: 'images.unsplash.com',
        port: '',
        pathname: '/**',
      },
      {
        protocol: 'https',
        hostname: 'picsum.photos',
        port: '',
        pathname: '/**',
      },
    ],
  },
};

export default nextConfig;
</file>

<file path="src/ai/flows/management-trust-score.ts">
'use server';

/**
 * @fileOverview Calculates a Management Trust Score for a given company based on earnings call transcripts and financial reports.
 *
 * - `calculateManagementTrustScore` - A function that calculates the management trust score.
 * - `ManagementTrustScoreInput` - The input type for the `calculateManagementTrustScore` function.
 * - `ManagementTrustScoreOutput` - The return type for the `calculateManagementTrustScore` function.
 */

import { generateForTask } from '@/ai/vertex';
import { z } from 'zod';

const ManagementTrustScoreInputSchema = z.object({
  companyName: z.string(),
  financialData: z.array(z.string()),
});
export type ManagementTrustScoreInput = z.infer<typeof ManagementTrustScoreInputSchema>;

const ManagementTrustScoreOutputSchema = z.object({
  managementTrustScore: z.number().min(0).max(100),
  reasoning: z.string(),
  citations: z.array(z.object({
    text: z.string(),
    source: z.string(),
  })),
});
export type ManagementTrustScoreOutput = z.infer<typeof ManagementTrustScoreOutputSchema>;

export async function calculateManagementTrustScore(input: ManagementTrustScoreInput): Promise<ManagementTrustScoreOutput> {
  const text = await generateForTask('managementTrustScore', input);
  try {
    return JSON.parse(text) as ManagementTrustScoreOutput;
  } catch (e: any) {
    try {
      const { extractJsonFromText } = await import('@/ai/utils');
      const extracted = extractJsonFromText(text || '');
      if (extracted) return JSON.parse(extracted) as ManagementTrustScoreOutput;
    } catch (ex) {
      // ignore and fall through to throw
    }

    throw new Error('Model returned non-JSON or invalid JSON for management trust score: ' + e.message + '\n' + text);
  }
}
</file>

<file path="src/ai/flows/regulatory-watch.ts">
'use server';
/**
 * @fileOverview Parses regulatory filings for red flags.
 *
 * - `checkForRedFlags` - A function that checks for red flags in regulatory filings.
 * - `RegulatoryWatchInput` - The input type for the `checkForRedFlags` function.
 * - `RegulatoryWatchOutput` - The return type for the `checkForRedFlags` function.
 */

import { generateForTask } from '@/ai/vertex';
import { z } from 'zod';

const RegulatoryWatchInputSchema = z.object({
  companyName: z.string(),
  filingText: z.string(),
});
export type RegulatoryWatchInput = z.infer<typeof RegulatoryWatchInputSchema>;

const RegulatoryWatchOutputSchema = z.object({
  redFlags: z.array(z.object({
    riskLevel: z.enum(['High', 'Medium', 'Low']),
    description: z.string(),
    implication: z.string(),
  })),
});
export type RegulatoryWatchOutput = z.infer<typeof RegulatoryWatchOutputSchema>;

export async function checkForRedFlags(input: RegulatoryWatchInput): Promise<RegulatoryWatchOutput> {
  const text = await generateForTask('regulatoryWatch', input);
  try {
    const parsed = JSON.parse(text);
    const validated = RegulatoryWatchOutputSchema.parse(parsed);
    return validated;
  } catch (e: any) {
    try {
      const { extractJsonFromText } = await import('@/ai/utils');
      const extracted = extractJsonFromText(text || '');
      if (extracted) {
        const parsedExtracted = JSON.parse(extracted);
        const validatedExtracted = RegulatoryWatchOutputSchema.parse(parsedExtracted);
        return validatedExtracted;
      }
    } catch (ex) {
      // ignore and fall through
    }

    throw new Error('Model returned non-JSON or invalid JSON for regulatory watch: ' + (e.message || '') + '\n' + text);
  }
}
</file>

<file path="src/app/dashboard/page.tsx">
import Link from 'next/link';
import { Card, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { ShieldCheck, TrendingUp, FileText, FileWarning } from 'lucide-react';

const features = [
  {
    title: 'Management Trust Score',
    description: 'Analyze management credibility and promise fulfillment.',
    href: '/management-trust',
    icon: <ShieldCheck className="h-6 w-6 text-accent" />,
  },
  {
    title: 'Macro-Shock Simulation',
    description: 'Simulate the impact of macro events on your portfolio.',
    href: '/macro-simulation',
    icon: <TrendingUp className="h-6 w-6 text-accent" />,
  },
  {
    title: 'Risk Factor Summary',
    description: 'Summarize key risk factors from financial documents.',
    href: '/risk-analysis',
    icon: <FileText className="h-6 w-6 text-accent" />,
  },
  {
    title: 'Regulatory Watch',
    description: 'Scan regulatory filings for potential red flags.',
    href: '/regulatory-watch',
    icon: <FileWarning className="h-6 w-6 text-accent" />,
  },
];

export default function DashboardPage() {
  return (
    <div className="flex-1 space-y-4 p-4 sm:p-8 pt-6">
      <div className="flex items-center justify-between space-y-2">
        <h1 className="text-3xl font-bold tracking-tight font-headline">
          Welcome to ClearFinanceAI
        </h1>
      </div>
      <div className="space-y-4">
        <p className="text-muted-foreground">
          Select a tool below to get started.
        </p>
        <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
          {features.map((feature) => (
            <Link href={feature.href} key={feature.href}>
              <Card className="hover:border-primary/80 hover:shadow-lg transition-all duration-300 h-full">
                <CardHeader>
                  <div className="flex items-center gap-4">
                    {feature.icon}
                    <CardTitle className="font-headline text-lg">{feature.title}</CardTitle>
                  </div>
                  <CardDescription className="pt-2">{feature.description}</CardDescription>
                </CardHeader>
              </Card>
            </Link>
          ))}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/app/macro-simulation/page.tsx">
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { MacroShockSimulator } from "@/components/features/macro-shock-simulator";
import { getPortfolioById } from '@/lib/portfolio';

export default async function MacroSimulationPage({ searchParams }: { searchParams?: { portfolioId?: string } | Promise<{ portfolioId?: string }> }) {
  const sp = (await searchParams) as { portfolioId?: string } | undefined;
  const portfolio = sp?.portfolioId ? await getPortfolioById(sp.portfolioId) : null;

  return (
    <div className="flex-1 space-y-4 p-4 sm:p-8 pt-6">
        <div className="flex items-center justify-between space-y-2">
            <h1 className="text-3xl font-bold tracking-tight font-headline">
                Macro-Shock Simulation
            </h1>
        </div>
        <Card>
            <CardHeader>
                <CardTitle className="font-headline">Simulate Portfolio Impact</CardTitle>
            </CardHeader>
            <CardContent>
                {/* server -> client prop */}
                <MacroShockSimulator portfolio={portfolio} />
            </CardContent>
        </Card>
    </div>
  );
}
</file>

<file path="src/app/management-trust/page.tsx">
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { ManagementTrustScore } from "@/components/features/management-trust-score";
import { getPortfolioById } from '@/lib/portfolio';

export default async function ManagementTrustPage({ searchParams }: { searchParams?: { portfolioId?: string } | Promise<{ portfolioId?: string }> }) {
  const sp = (await searchParams) as { portfolioId?: string } | undefined;
  const portfolio = sp?.portfolioId ? await getPortfolioById(sp.portfolioId) : null;

  return (
    <div className="flex-1 space-y-4 p-4 sm:p-8 pt-6">
        <div className="flex items-center justify-between space-y-2">
            <h1 className="text-3xl font-bold tracking-tight font-headline">
                Management Trust Score
            </h1>
        </div>
        <Card>
            <CardHeader>
                <CardTitle className="font-headline">Analyze Management Credibility</CardTitle>
            </CardHeader>
            <CardContent>
                {/* server -> client prop */}
                <ManagementTrustScore portfolio={portfolio} />
            </CardContent>
        </Card>
    </div>
  );
}
</file>

<file path="src/app/regulatory-watch/page.tsx">
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { RegulatoryWatch } from "@/components/features/regulatory-watch";
import { getPortfolioById } from '@/lib/portfolio';

export default async function RegulatoryWatchPage({ searchParams }: { searchParams?: { portfolioId?: string } | Promise<{ portfolioId?: string }> }) {
  const sp = (await searchParams) as { portfolioId?: string } | undefined;
  const portfolio = sp?.portfolioId ? await getPortfolioById(sp.portfolioId) : null;

  return (
    <div className="flex-1 space-y-4 p-4 sm:p-8 pt-6">
        <div className="flex items-center justify-between space-y-2">
            <h1 className="text-3xl font-bold tracking-tight font-headline">
                Regulatory Watch
            </h1>
        </div>
        <Card>
            <CardHeader>
                <CardTitle className="font-headline">Scan Filings for Red Flags</CardTitle>
            </CardHeader>
            <CardContent>
                {/* server -> client prop */}
                <RegulatoryWatch portfolio={portfolio} />
            </CardContent>
        </Card>
    </div>
  );
}
</file>

<file path="src/app/risk-analysis/page.tsx">
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { RiskFactorSummary } from "@/components/features/risk-factor-summary";
import { getPortfolioById } from '@/lib/portfolio';

export default async function RiskAnalysisPage({ searchParams }: { searchParams?: { portfolioId?: string } | Promise<{ portfolioId?: string }> }) {
  const sp = (await searchParams) as { portfolioId?: string } | undefined;
  const portfolio = sp?.portfolioId ? await getPortfolioById(sp.portfolioId) : null;

  return (
    <div className="flex-1 space-y-4 p-4 sm:p-8 pt-6">
        <div className="flex items-center justify-between space-y-2">
            <h1 className="text-3xl font-bold tracking-tight font-headline">
                Risk Factor Summary
            </h1>
        </div>
        <Card>
            <CardHeader>
                <CardTitle className="font-headline">Summarize Key Risk Factors</CardTitle>
            </CardHeader>
            <CardContent>
                {/* server -> client prop */}
                <RiskFactorSummary portfolio={portfolio} />
            </CardContent>
        </Card>
    </div>
  );
}
</file>

<file path="src/components/features/regulatory-watch.tsx">
'use client';

import { useState } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import * as z from 'zod';
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';

import type { RegulatoryWatchOutput } from '@/ai/flows/regulatory-watch';
import { useToast } from '@/hooks/use-toast';
import { Loader2, AlertTriangle } from 'lucide-react';
import { Badge } from '@/components/ui/badge';
import { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from '@/components/ui/accordion';

const FormSchema = z.object({
  companyName: z.string().min(2, 'Company name is required.'),
  filingText: z.string().min(50, 'Filing text is too short.'),
});

const defaultFilingText = `Fictional FMCG Ltd. - Board Meeting Outcome

The Board of Directors at their meeting held today, has approved the resignation of M/s. Old & Associates, Chartered Accountants, as the Statutory Auditors of the Company with immediate effect.

The Board has also approved the appointment of M/s. New & Co., Chartered Accountants, as the new Statutory Auditors, subject to shareholder approval. This change is being made to leverage the new firm's expertise in the digital and e-commerce space, which is a growing part of our business.

Additionally, Mr. Promoter, a member of the promoter group, has pledged 5% of his shareholding in the company to secure a personal loan. The company has taken note of the disclosure.`;

const RiskBadge = ({ level }: { level: 'High' | 'Medium' | 'Low' }) => {
  const variant = {
    'High': 'destructive',
    'Medium': 'secondary',
    'Low': 'default',
  }[level] as "destructive" | "secondary" | "default";
  return <Badge variant={variant}>{level} Risk</Badge>;
};

export function RegulatoryWatch({ portfolio }: { portfolio?: any } = {}) {
  const [result, setResult] = useState<RegulatoryWatchOutput | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const { toast } = useToast();

  const form = useForm<z.infer<typeof FormSchema>>({
    resolver: zodResolver(FormSchema),
    defaultValues: {
      companyName: '',
      filingText: defaultFilingText,
    },
  });

  async function onSubmit(data: z.infer<typeof FormSchema>) {
    setIsLoading(true);
    setResult(null);

    // If a portfolio is provided, request the regulatory watch for the portfolio (server will pick a company)
    const body = portfolio?.id ? { task: 'regulatoryWatch', input: { portfolioId: portfolio.id } } : { task: 'regulatoryWatch', input: data };

    const res = await fetch('/api/insights', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    setIsLoading(false);
    const json = await res.json();
    if (!res.ok) {
      toast({ variant: 'destructive', title: 'Error', description: json?.error || 'Unknown error' });
    } else {
      try {
        const parsed = JSON.parse(json.text);
        setResult(parsed);
      } catch (e: any) {
        toast({ variant: 'destructive', title: 'Error parsing response', description: e.message || 'Invalid JSON returned from model.' });
      }
    }
  }

  return (
    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div className="lg:col-span-1">
        <Form {...form}>
          <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
            <FormField
              control={form.control}
              name="companyName"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Company Name</FormLabel>
                  <FormControl>
                    <Input placeholder="e.g., Fictional FMCG Ltd." {...field} />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />
            <FormField
              control={form.control}
              name="filingText"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Regulatory Filing Text</FormLabel>
                  <FormControl>
                    <Textarea className="min-h-[200px] text-xs" {...field} />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />
            <div className="grid grid-cols-1 gap-2">
              <Button type="submit" disabled={isLoading} className="w-full bg-accent hover:bg-accent/90">
                {isLoading && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                Scan for Red Flags
              </Button>
              {portfolio?.id && (
                <Button
                  type="button"
                  disabled={isLoading}
                  variant="outline"
                  onClick={async () => {
                    setIsLoading(true);
                    setResult(null);
                    const res = await fetch('/api/insights', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ task: 'regulatoryWatch', input: { portfolioId: portfolio.id } }),
                    });
                    setIsLoading(false);
                    const json = await res.json();
                    if (!res.ok) {
                      toast({ variant: 'destructive', title: 'Error', description: json?.error || 'Unknown error' });
                    } else {
                      try {
                        const parsed = JSON.parse(json.text);
                        setResult(parsed);
                      } catch (e: any) {
                        toast({ variant: 'destructive', title: 'Error parsing response', description: e.message || 'Invalid JSON returned from model.' });
                      }
                    }
                  }}
                >
                  {isLoading && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                  Scan Portfolio
                </Button>
              )}
            </div>
          </form>
        </Form>
      </div>
      <div className="lg:col-span-1">
        {isLoading && (
          <div className="flex items-center justify-center h-full min-h-[300px]">
            <div className="text-center">
              <Loader2 className="mx-auto h-12 w-12 animate-spin text-primary" />
              <p className="mt-4 text-muted-foreground">Scanning filing...</p>
            </div>
          </div>
        )}
        {result && (
          <Card>
            <CardHeader>
              <div className="flex items-center justify-between">
                <CardTitle className="flex items-center gap-2 font-headline">
                  <AlertTriangle className="h-5 w-5 text-destructive" />
                  Identified Red Flags
                </CardTitle>
                <div className="text-right">
                  {portfolio?.name && <div className="text-sm text-muted-foreground">Portfolio: <span className="font-semibold">{portfolio.name}</span></div>}
                  <span className="text-2xl font-bold">{result.redFlags.length}</span>
                </div>
              </div>
            </CardHeader>
            <CardContent>
              {result.redFlags.length > 0 ? (
                <Accordion type="single" collapsible className="w-full">
                  {result.redFlags.map((flag, index) => (
                    <AccordionItem value={`item-${index}`} key={index}>
                      <AccordionTrigger>
                        <div className="flex items-center gap-4 text-left">
                            <RiskBadge level={flag.riskLevel} />
                            <span className="flex-1">{flag.description}</span>
                        </div>
                      </AccordionTrigger>
                      <AccordionContent>
                        <p className="text-sm text-muted-foreground">{flag.implication}</p>
                      </AccordionContent>
                    </AccordionItem>
                  ))}
                </Accordion>
              ) : (
                <p className="text-center text-muted-foreground py-10">
                  No significant red flags identified in this filing.
                </p>
              )}
            </CardContent>
          </Card>
        )}
        {!isLoading && !result && (
          <div className="flex items-center justify-center h-full min-h-[300px] border-2 border-dashed rounded-lg">
            <p className="text-center text-muted-foreground">
              Enter filing details to scan for red flags.
            </p>
          </div>
        )}
      </div>
    </div>
  );
}
</file>

<file path="src/components/layout/header.tsx">
'use client';
import React from 'react';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { SidebarTrigger } from '@/components/ui/sidebar';
import { Button } from '@/components/ui/button';
import { PlaceHolderImages } from '@/lib/placeholder-images';
import Image from 'next/image';

export function Header() {
  const userAvatar = PlaceHolderImages.find((img) => img.id === 'user-avatar');
  const triggerId = React.useId();

  return (
    <header className="sticky top-0 z-30 flex h-14 items-center gap-4 border-b bg-background/80 backdrop-blur-lg px-4 sm:px-6">
      <SidebarTrigger className="md:hidden" />
      <div className="w-full flex-1">
        {/* Can be used for breadcrumbs or page title */}
      </div>
      <DropdownMenu>
        <DropdownMenuTrigger asChild>
          <Button id={triggerId} variant="ghost" className="relative h-10 w-10 rounded-full">
            <Avatar className="h-10 w-10">
              {userAvatar && (
                 <Image
                    src={userAvatar.imageUrl}
                    alt={userAvatar.description}
                    data-ai-hint={userAvatar.imageHint}
                    width={100}
                    height={100}
                    className="aspect-square h-full w-full"
                 />
              )}
              <AvatarFallback>RI</AvatarFallback>
            </Avatar>
          </Button>
        </DropdownMenuTrigger>
        <DropdownMenuContent className="w-56" align="end" forceMount>
          <DropdownMenuLabel className="font-normal">
            <div className="flex flex-col space-y-1">
              <p className="text-sm font-medium leading-none">Retail Investor</p>
              <p className="text-xs leading-none text-muted-foreground">
                user@example.com
              </p>
            </div>
          </DropdownMenuLabel>
          <DropdownMenuSeparator />
          <DropdownMenuItem>Profile</DropdownMenuItem>
          <DropdownMenuItem>Settings</DropdownMenuItem>
          <DropdownMenuSeparator />
          <DropdownMenuItem>Log out</DropdownMenuItem>
        </DropdownMenuContent>
      </DropdownMenu>
    </header>
  );
}
</file>

<file path="src/components/ui/calendar.tsx">
"use client"

import * as React from "react"
import { ChevronLeft, ChevronRight } from "lucide-react"
import { DayPicker } from "react-day-picker"

import { cn } from "@/lib/utils"
import { buttonVariants } from "@/components/ui/button"

export type CalendarProps = React.ComponentProps<typeof DayPicker>

function Calendar({
  className,
  classNames,
  showOutsideDays = true,
  ...props
}: CalendarProps) {
  return (
    <DayPicker
      showOutsideDays={showOutsideDays}
      className={cn("p-3", className)}
      classNames={{
        months: "flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0",
        month: "space-y-4",
        caption: "flex justify-center pt-1 relative items-center",
        caption_label: "text-sm font-medium",
        nav: "space-x-1 flex items-center",
        nav_button: cn(
          buttonVariants({ variant: "outline" }),
          "h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100"
        ),
        nav_button_previous: "absolute left-1",
        nav_button_next: "absolute right-1",
        table: "w-full border-collapse space-y-1",
        head_row: "flex",
        head_cell:
          "text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]",
        row: "flex w-full mt-2",
        cell: "h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20",
        day: cn(
          buttonVariants({ variant: "ghost" }),
          "h-9 w-9 p-0 font-normal aria-selected:opacity-100"
        ),
        day_range_end: "day-range-end",
        day_selected:
          "bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground",
        day_today: "bg-accent text-accent-foreground",
        day_outside:
          "day-outside text-muted-foreground aria-selected:bg-accent/50 aria-selected:text-muted-foreground",
        day_disabled: "text-muted-foreground opacity-50",
        day_range_middle:
          "aria-selected:bg-accent aria-selected:text-accent-foreground",
        day_hidden: "invisible",
        ...classNames,
      }}
      // Some DayPicker versions expect a different shape for `components`; assign to a temporary any-typed object to avoid excess property errors.
      components={( {
        IconLeft: ({ className, ...props }: any) => (
          <ChevronLeft className={cn("h-4 w-4", className)} {...props} />
        ),
        IconRight: ({ className, ...props }: any) => (
          <ChevronRight className={cn("h-4 w-4", className)} {...props} />
        ),
      } as any) }
      {...props}
    />
  )
}
Calendar.displayName = "Calendar"

export { Calendar }
</file>

<file path="src/components/ui/chart.tsx">
"use client"

import * as React from "react"
import * as RechartsPrimitive from "recharts"

import { cn } from "@/lib/utils"

// Format: { THEME_NAME: CSS_SELECTOR }
const THEMES = { light: "", dark: ".dark" } as const

export type ChartConfig = {
  [k in string]: {
    label?: React.ReactNode
    icon?: React.ComponentType
  } & (
    | { color?: string; theme?: never }
    | { color?: never; theme: Record<keyof typeof THEMES, string> }
  )
}

type ChartContextProps = {
  config: ChartConfig
}

const ChartContext = React.createContext<ChartContextProps | null>(null)

function useChart() {
  const context = React.useContext(ChartContext)

  if (!context) {
    throw new Error("useChart must be used within a <ChartContainer />")
  }

  return context
}

const ChartContainer = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> & {
    config: ChartConfig
    children: React.ComponentProps<
      typeof RechartsPrimitive.ResponsiveContainer
    >["children"]
  }
>(({ id, className, children, config, ...props }, ref) => {
  const uniqueId = React.useId()
  const chartId = `chart-${id || uniqueId.replace(/:/g, "")}`

  return (
    <ChartContext.Provider value={{ config }}>
      <div
        data-chart={chartId}
        ref={ref}
        className={cn(
          "flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none",
          className
        )}
        {...props}
      >
        <ChartStyle id={chartId} config={config} />
        <RechartsPrimitive.ResponsiveContainer>
          {children}
        </RechartsPrimitive.ResponsiveContainer>
      </div>
    </ChartContext.Provider>
  )
})
ChartContainer.displayName = "Chart"

const ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {
  const colorConfig = Object.entries(config).filter(
    ([, config]) => config.theme || config.color
  )

  if (!colorConfig.length) {
    return null
  }

  return (
    <style
      dangerouslySetInnerHTML={{
        __html: Object.entries(THEMES)
          .map(
            ([theme, prefix]) => `
${prefix} [data-chart=${id}] {
${colorConfig
  .map(([key, itemConfig]) => {
    const color =
      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||
      itemConfig.color
    return color ? `  --color-${key}: ${color};` : null
  })
  .join("\n")}
}
`
          )
          .join("\n"),
      }}
    />
  )
}

const ChartTooltip = RechartsPrimitive.Tooltip

// Use loose types for tooltip props to avoid brittle recharts typings
const ChartTooltipContent = React.forwardRef<
  HTMLDivElement,
  any
>(
  (
    {
      active,
      payload,
      className,
      indicator = "dot",
      hideLabel = false,
      hideIndicator = false,
      label,
      labelFormatter,
      labelClassName,
      formatter,
      color,
      nameKey,
      labelKey,
    },
    ref
  ) => {
    const { config } = useChart()

    const tooltipLabel = React.useMemo(() => {
      if (hideLabel || !payload?.length) {
        return null
      }

      const [item] = payload
      const key = `${labelKey || item.dataKey || item.name || "value"}`
      const itemConfig = getPayloadConfigFromPayload(config, item, key)
      const value =
        !labelKey && typeof label === "string"
          ? config[label as keyof typeof config]?.label || label
          : itemConfig?.label

      if (labelFormatter) {
        return (
          <div className={cn("font-medium", labelClassName)}>
            {labelFormatter(value, payload)}
          </div>
        )
      }

      if (!value) {
        return null
      }

      return <div className={cn("font-medium", labelClassName)}>{value}</div>
    }, [
      label,
      labelFormatter,
      payload,
      hideLabel,
      labelClassName,
      config,
      labelKey,
    ])

    if (!active || !payload?.length) {
      return null
    }

    const nestLabel = payload.length === 1 && indicator !== "dot"

    return (
      <div
        ref={ref}
        className={cn(
          "grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl",
          className
        )}
      >
        {!nestLabel ? tooltipLabel : null}
        <div className="grid gap-1.5">
          {payload.map((item: any, index: number) => {
            const key = `${nameKey || item.name || item.dataKey || "value"}`
            const itemConfig = getPayloadConfigFromPayload(config, item, key)
            const indicatorColor = color || item.payload?.fill || item.color

            return (
              <div
                key={item.dataKey}
                className={cn(
                  "flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground",
                  indicator === "dot" && "items-center"
                )}
              >
                {formatter && item?.value !== undefined && item.name ? (
                  formatter(item.value, item.name, item, index, item.payload)
                ) : (
                  <>
                    {itemConfig?.icon ? (
                      <itemConfig.icon />
                    ) : (
                      !hideIndicator && (
                        <div
                          className={cn(
                            "shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]",
                            {
                              "h-2.5 w-2.5": indicator === "dot",
                              "w-1": indicator === "line",
                              "w-0 border-[1.5px] border-dashed bg-transparent":
                                indicator === "dashed",
                              "my-0.5": nestLabel && indicator === "dashed",
                            }
                          )}
                          style={
                            {
                              "--color-bg": indicatorColor,
                              "--color-border": indicatorColor,
                            } as React.CSSProperties
                          }
                        />
                      )
                    )}
                    <div
                      className={cn(
                        "flex flex-1 justify-between leading-none",
                        nestLabel ? "items-end" : "items-center"
                      )}
                    >
                      <div className="grid gap-1.5">
                        {nestLabel ? tooltipLabel : null}
                        <span className="text-muted-foreground">
                          {itemConfig?.label || item.name}
                        </span>
                      </div>
                      {item.value && (
                        <span className="font-mono font-medium tabular-nums text-foreground">
                          {item.value.toLocaleString()}
                        </span>
                      )}
                    </div>
                  </>
                )}
              </div>
            )
          })}
        </div>
      </div>
    )
  }
)
ChartTooltipContent.displayName = "ChartTooltip"

const ChartLegend = RechartsPrimitive.Legend

// Loose legend props typing to avoid type churn with Recharts types
const ChartLegendContent = React.forwardRef<
  HTMLDivElement,
  any
>(
  (
    { className, hideIcon = false, payload, verticalAlign = "bottom", nameKey },
    ref
  ) => {
    const { config } = useChart()

    if (!payload?.length) {
      return null
    }

    return (
      <div
        ref={ref}
        className={cn(
          "flex items-center justify-center gap-4",
          verticalAlign === "top" ? "pb-3" : "pt-3",
          className
        )}
      >
        {payload.map((item: any) => {
          const key = `${nameKey || item.dataKey || "value"}`
          const itemConfig = getPayloadConfigFromPayload(config, item, key)

          return (
            <div
              key={item.value}
              className={cn(
                "flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground"
              )}
            >
              {itemConfig?.icon && !hideIcon ? (
                <itemConfig.icon />
              ) : (
                <div
                  className="h-2 w-2 shrink-0 rounded-[2px]"
                  style={{
                    backgroundColor: item.color,
                  }}
                />
              )}
              {itemConfig?.label}
            </div>
          )
        })}
      </div>
    )
  }
)
ChartLegendContent.displayName = "ChartLegend"

// Helper to extract item config from a payload.
function getPayloadConfigFromPayload(
  config: ChartConfig,
  payload: unknown,
  key: string
) {
  if (typeof payload !== "object" || payload === null) {
    return undefined
  }

  const payloadPayload =
    "payload" in payload &&
    typeof payload.payload === "object" &&
    payload.payload !== null
      ? payload.payload
      : undefined

  let configLabelKey: string = key

  if (
    key in payload &&
    typeof payload[key as keyof typeof payload] === "string"
  ) {
    configLabelKey = payload[key as keyof typeof payload] as string
  } else if (
    payloadPayload &&
    key in payloadPayload &&
    typeof payloadPayload[key as keyof typeof payloadPayload] === "string"
  ) {
    configLabelKey = payloadPayload[
      key as keyof typeof payloadPayload
    ] as string
  }

  return configLabelKey in config
    ? config[configLabelKey]
    : config[key as keyof typeof config]
}

export {
  ChartContainer,
  ChartTooltip,
  ChartTooltipContent,
  ChartLegend,
  ChartLegendContent,
  ChartStyle,
}
</file>

<file path="src/lib/placeholder-images.json">
{
  "placeholderImages": [
    {
      "id": "user-avatar",
      "description": "User avatar",
      "imageUrl": "https://images.unsplash.com/photo-1540569014015-19a7be504e3a?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w3NDE5ODJ8MHwxfHNlYXJjaHwyfHxwZXJzb24lMjBwb3J0cmFpdHxlbnwwfHx8fDE3NjY3NTQyNTR8MA&ixlib=rb-4.1.0&q=80&w=1080",
      "imageHint": "person portrait"
    }
  ]
}
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": [
      "dom",
      "dom.iterable",
      "esnext"
    ],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": [
        "./src/*"
      ]
    },
    "types": [
      "node"
    ],
    "typeRoots": [
      "node_modules/@types",
      "src/types"
    ]
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts"
  ],
  "exclude": [
    "node_modules"
  ]
}
</file>

<file path="src/ai/dev.ts">
import { config } from 'dotenv';
config();

import '@/ai/flows/portfolio-impact-of-macro-events.ts';
import '@/ai/flows/summarize-risk-factors.ts';
import '@/ai/flows/management-trust-score.ts';
import '@/ai/flows/regulatory-watch.ts';
</file>

<file path="src/ai/flows/portfolio-impact-of-macro-events.ts">
'use server';
/**
 * @fileOverview Simulates the impact of a macro event on a user's portfolio.
 *
 * - simulatePortfolioImpact - Simulates the impact of a macro event on a user's portfolio.
 * - SimulatePortfolioImpactInput - The input type for the simulatePortfolioImpact function.
 * - SimulatePortfolioImpactOutput - The return type for the simulatePortfolioImpact function.
 */

import { generateForTask } from '@/ai/vertex';
import { z } from 'zod';

const SimulatePortfolioImpactInputSchema = z.object({
  portfolioHoldings: z.string(),
  macroEvent: z.string(),
  tavilyContext: z.string().optional(), // Real-time company data from Tavily API
});
export type SimulatePortfolioImpactInput = z.infer<typeof SimulatePortfolioImpactInputSchema>;

const SimulatePortfolioImpactOutputSchema = z.object({
  expectedDrawdown: z.string(),
  sectorSensitivity: z.string(),
  downsideRisk: z.string(),
  reasoning: z.string(),
  // Optional suggested action: the model may recommend an action and details
  suggestedAction: z
    .object({ action: z.string(), details: z.string() })
    .optional(),
});
export type SimulatePortfolioImpactOutput = z.infer<typeof SimulatePortfolioImpactOutputSchema>;

export async function simulatePortfolioImpact(input: SimulatePortfolioImpactInput): Promise<SimulatePortfolioImpactOutput> {
  const text = await generateForTask('simulatePortfolioImpact', input);

  // Parse and validate using zod; try to normalize common alternate shapes returned by the model
  let parsed: any;
  try {
    parsed = JSON.parse(text);
  } catch (e: any) {
    // Try to salvage JSON if model wrapped it in markdown/code fences
    try {
      const { extractJsonFromText } = await import('@/ai/utils');
      const extracted = extractJsonFromText(text || '');
      if (extracted) parsed = JSON.parse(extracted);
    } catch (ex) {
      // ignore and fall through to throw
    }
  }

  if (!parsed) {
    throw new Error('Model returned non-JSON or invalid JSON for portfolio impact: ' + (text || ''));
  }

  const maybe = SimulatePortfolioImpactOutputSchema.safeParse(parsed);
  if (maybe.success) return maybe.data;

  // Attempt normalization for common alternate shapes
  const candidate: Partial<SimulatePortfolioImpactOutput> = {};

  // Handle alternative structure where data might be nested under company keys
  // e.g., { "HDFCBANK": { rationale: "...", macro_event_impact: "...", ... } }
  if (typeof parsed === 'object' && parsed !== null && !Array.isArray(parsed)) {
    const keys = Object.keys(parsed);
    // If the structure has keys that look like company tickers, extract data from first one
    // Check if any key contains company data (not standard fields)
    const hasStandardFields = 'expectedDrawdown' in parsed || 'reasoning' in parsed || 'downsideRisk' in parsed;
    
    if (!hasStandardFields && keys.length > 0) {
      // Likely nested structure - extract from first company key
      for (const key of keys) {
        const companyData = parsed[key];
        if (typeof companyData === 'object' && companyData !== null && !Array.isArray(companyData)) {
          // Map alternative field names from nested structure to top level
          if (companyData.rationale && typeof companyData.rationale === 'string') {
            parsed.reasoning = companyData.rationale;
          }
          if (companyData.macro_event_impact && typeof companyData.macro_event_impact === 'string') {
            parsed.downsideRisk = companyData.macro_event_impact;
          }
          if (companyData.suggested_action && typeof companyData.suggested_action === 'string') {
            parsed.suggestedAction = { action: companyData.suggested_action, details: '' };
          }
          // Try to construct expectedDrawdown from allocation info
          if (companyData.current_allocation && typeof companyData.current_allocation === 'string') {
            parsed.expectedDrawdown = `Impact on ${companyData.current_allocation} allocation`;
          }
          break; // Use first company's data
        }
      }
    }
    
    // Also check if rationale exists at top level (after potential extraction)
    if (parsed.rationale && typeof parsed.rationale === 'string' && !parsed.reasoning) {
      parsed.reasoning = parsed.rationale;
    }
    if (parsed.macro_event_impact && typeof parsed.macro_event_impact === 'string' && !parsed.downsideRisk) {
      parsed.downsideRisk = parsed.macro_event_impact;
    }
  }

  // Top-level fields
  if (typeof parsed.expectedDrawdown === 'string') candidate.expectedDrawdown = parsed.expectedDrawdown;
  if (typeof parsed.sectorSensitivity === 'string') candidate.sectorSensitivity = parsed.sectorSensitivity;
  if (typeof parsed.downsideRisk === 'string') candidate.downsideRisk = parsed.downsideRisk;
  if (typeof parsed.reasoning === 'string') candidate.reasoning = parsed.reasoning;
  // Also check for rationale as an alias for reasoning
  if (!candidate.reasoning && typeof parsed.rationale === 'string') candidate.reasoning = parsed.rationale;

  // Top-level suggestedAction normalization
  if (!candidate.suggestedAction && parsed && typeof parsed.suggestedAction === 'object') {
    const sa = parsed.suggestedAction as any;
    if (typeof sa.action === 'string' && typeof sa.details === 'string') {
      candidate.suggestedAction = { action: sa.action, details: sa.details };
    } else {
      candidate.suggestedAction = {
        action: sa.action ?? sa.recommendation ?? 'Action',
        details: sa.details ?? sa.note ?? JSON.stringify(sa),
      };
    }
  } else if (!candidate.suggestedAction && parsed && typeof parsed.suggestedAction === 'string') {
    candidate.suggestedAction = { action: 'Suggestion', details: parsed.suggestedAction };
  }

  // Nested under processedData or processed
  const pd = parsed.processedData || parsed.processed || parsed.data || null;
  if (pd) {
    if (!candidate.expectedDrawdown && typeof pd.expectedDrawdown === 'string') candidate.expectedDrawdown = pd.expectedDrawdown;
    if (!candidate.expectedDrawdown && typeof pd.drawdown === 'string') candidate.expectedDrawdown = pd.drawdown;
    if (!candidate.sectorSensitivity && typeof pd.sectorSensitivity === 'string') candidate.sectorSensitivity = pd.sectorSensitivity;
    if (!candidate.downsideRisk && typeof pd.downsideRisk === 'string') candidate.downsideRisk = pd.downsideRisk;
    if (!candidate.downsideRisk && typeof pd.risk === 'string') candidate.downsideRisk = pd.risk;
    if (!candidate.downsideRisk && typeof pd.macro_event_impact === 'string') candidate.downsideRisk = pd.macro_event_impact;
    if (!candidate.reasoning && typeof pd.analysisNote === 'string') candidate.reasoning = pd.analysisNote;
    if (!candidate.reasoning && typeof pd.rationale === 'string') candidate.reasoning = pd.rationale;
  }

  // Some models return a flattened 'insights' or 'analysis' object
  const insights = parsed.insights || parsed.analysis || null;
  if (insights) {
    if (!candidate.expectedDrawdown && typeof insights.expectedDrawdown === 'string') candidate.expectedDrawdown = insights.expectedDrawdown;
    if (!candidate.downsideRisk && typeof insights.downsideRisk === 'string') candidate.downsideRisk = insights.downsideRisk;
    if (!candidate.sectorSensitivity && typeof insights.sectorSensitivity === 'string') candidate.sectorSensitivity = insights.sectorSensitivity;
    if (!candidate.reasoning && typeof insights.reasoning === 'string') candidate.reasoning = insights.reasoning;
    if (!candidate.suggestedAction && typeof insights.suggestedAction === 'object') candidate.suggestedAction = insights.suggestedAction;
    if (!candidate.suggestedAction && typeof insights.recommendation === 'string') candidate.suggestedAction = { action: insights.recommendation, details: insights.recommendationDetails || '' };
  }


  // Debug logging to help troubleshoot
  if (!candidate.reasoning) {
    console.log('No reasoning found in candidate. Parsed object keys:', Object.keys(parsed));
    console.log('Parsed object structure:', JSON.stringify(parsed, null, 2).substring(0, 500));
  }

  // If we managed to populate the required fields, return after validation
  const normalized = {
    expectedDrawdown: candidate.expectedDrawdown ?? (candidate.reasoning ? 'See analysis below' : 'N/A'),
    sectorSensitivity: candidate.sectorSensitivity ?? (candidate.reasoning ? candidate.reasoning.substring(0, 150) + '...' : 'N/A'),
    downsideRisk: candidate.downsideRisk ?? (candidate.reasoning ? 'See analysis' : 'N/A'),
    reasoning: candidate.reasoning ?? 'No reasoning provided by the model.',
    suggestedAction: candidate.suggestedAction ?? undefined,
  };

  const validated = SimulatePortfolioImpactOutputSchema.safeParse(normalized);
  if (validated.success) {
    console.warn('Normalized model output for simulatePortfolioImpact (returned by model):', parsed);
    return validated.data;
  }

  // Attempt to salvage a free-text suggested action if present in the raw text
  if (!normalized.suggestedAction && text) {
    const match = text.match(/(?:Suggested Action|Recommendation)[:\-]\s*([\s\S]{1,500})/i);
    if (match) {
      const raw = match[1].trim();
      // Split by sentence or newline — first fragment as action, rest as details
      const [first, ...rest] = raw.split(/\n|\.|;|\r/).map((s) => s.trim()).filter(Boolean);
      if (first) {
        const made = { action: first, details: rest.join('. ').trim() };
        const finalNorm = { ...normalized, suggestedAction: made };
        const finalValidated = SimulatePortfolioImpactOutputSchema.safeParse(finalNorm);
        if (finalValidated.success) {
          console.warn('Extracted suggestedAction from model text for simulatePortfolioImpact:', raw);
          return finalValidated.data;
        }
      }
    }
  }

  // If still invalid, throw with helpful debug info
  throw new Error('Model returned unexpected shape for portfolio impact. Raw output:\n' + JSON.stringify(parsed, null, 2));
}
</file>

<file path="src/ai/flows/summarize-risk-factors.ts">
'use server';

/**
 * @fileOverview Summarizes key risk factors for a given company from financial documents.
 *
 * - summarizeRiskFactors - A function that summarizes risk factors.
 * - SummarizeRiskFactorsInput - The input type for the summarizeRiskFactors function.
 * - SummarizeRiskFactorsOutput - The return type for the summarizeRiskFactors function.
 */

import { generateForTask } from '@/ai/vertex';
import { z } from 'zod';

const SummarizeRiskFactorsInputSchema = z.object({
  companyName: z.string(),
  financialReport: z.string(),
});
export type SummarizeRiskFactorsInput = z.infer<typeof SummarizeRiskFactorsInputSchema>;

const SummarizeRiskFactorsOutputSchema = z.object({
  riskFactorSummary: z.array(z.string()),
});
export type SummarizeRiskFactorsOutput = z.infer<typeof SummarizeRiskFactorsOutputSchema>;

export async function summarizeRiskFactors(input: SummarizeRiskFactorsInput): Promise<SummarizeRiskFactorsOutput> {
  const text = await generateForTask('summarizeRiskFactors', input);
  try {
    return JSON.parse(text) as SummarizeRiskFactorsOutput;
  } catch (e: any) {
    try {
      const { extractJsonFromText } = await import('@/ai/utils');
      const extracted = extractJsonFromText(text || '');
      if (extracted) return JSON.parse(extracted) as SummarizeRiskFactorsOutput;
    } catch (ex) {
      // ignore and fall through
    }

    throw new Error('Model returned non-JSON or invalid JSON for risk summary: ' + e.message + '\n' + text);
  }
}
</file>

<file path="src/app/globals.css">
/* stylelint-disable-next-line at-rule-no-unknown */
@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  :root {
    --background: 0 0% 100%;
    --foreground: 0 0% 12%;
    --card: 0 0% 100%;
    --card-foreground: 0 0% 12%;
    --popover: 0 0% 100%;
    --popover-foreground: 0 0% 12%;
    --primary: 222 90% 47%;
    --primary-foreground: 0 0% 100%;
    --secondary: 0 0% 96%;
    --secondary-foreground: 0 0% 20%;
    --muted: 0 0% 96%;
    --muted-foreground: 0 0% 50%;
    --accent: 180 100% 25%;
    --accent-foreground: 0 0% 100%;
    --destructive: 0 62.8% 30.6%;
    --destructive-foreground: 0 0% 100%;
    --border: 0 0% 90%;
    --input: 0 0% 96%;
    --ring: 222 100% 47%;
    --radius: 0.5rem;
    --chart-1: 222 90% 47%;
    --chart-2: 180 100% 25%;
    --chart-3: 222 80% 50%;
    --chart-4: 180 80% 40%;
    --chart-5: 222 60% 60%;
    --sidebar-background: 0 0% 100%;
    --sidebar-foreground: 0 0% 20%;
    --sidebar-primary: 0 0% 12%;
    --sidebar-primary-foreground: 0 0% 100%;
    --sidebar-accent: 0 0% 94%;
    --sidebar-accent-foreground: 0 0% 20%;
    --sidebar-border: 0 0% 90%;
    --sidebar-ring: 180 100% 25%;
  }

  .dark {
    --background: 240 10% 8%;
    --foreground: 0 0% 98%;
    --card: 240 8% 12%;
    --card-foreground: 0 0% 95%;
    --popover: 240 10% 10%;
    --popover-foreground: 0 0% 98%;
    --primary: 263 70% 50%;
    --primary-foreground: 0 0% 100%;
    --secondary: 240 8% 15%;
    --secondary-foreground: 0 0% 98%;
    --muted: 240 8% 15%;
    --muted-foreground: 0 0% 60%;
    --accent: 177 70% 41%;
    --accent-foreground: 0 0% 100%;
    --destructive: 0 62.8% 50%;
    --destructive-foreground: 0 0% 100%;
    --border: 240 8% 18%;
    --input: 240 8% 18%;
    --ring: 263 70% 50%;
    --chart-1: 263 70% 50%;
    --chart-2: 177 70% 41%;
    --chart-3: 263 60% 60%;
    --chart-4: 177 60% 50%;
    --chart-5: 263 50% 70%;
    --sidebar-background: 250 15% 10%;
    --sidebar-foreground: 240 5% 70%;
    --sidebar-primary: 263 70% 50%;
    --sidebar-primary-foreground: 0 0% 100%;
    --sidebar-accent: 250 12% 18%;
    --sidebar-accent-foreground: 0 0% 95%;
    --sidebar-border: 250 10% 15%;
    --sidebar-ring: 263 70% 50%;
  }
}

@layer base {
  * {
    @apply border-border;
  }
  body {
    @apply bg-background text-foreground;
  }
}

@layer utilities {
  .border-border {
    border-color: hsl(var(--border));
  }

  .bg-background {
    background-color: hsl(var(--background));
  }

  .text-foreground {
    color: hsl(var(--foreground));
  }
}
</file>

<file path="src/app/layout.tsx">
import type { Metadata } from 'next';
import './globals.css';
import { Toaster } from "@/components/ui/toaster";
import AppLayout from '@/components/layout/app-layout';

export const metadata: Metadata = {
  title: 'ClearFinanceAI',
  description: 'AI-first forensic intelligence engine for Indian retail investors.',
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en" className="light">
      <head>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossOrigin="anonymous" />
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
      </head>
      <body className="font-body antialiased">
        <AppLayout>
          {children}
        </AppLayout>
        <Toaster />
      </body>
    </html>
  );
}
</file>

<file path="src/components/features/macro-shock-simulator.tsx">
'use client';

import { useState, useEffect, useRef } from 'react';
import * as React from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import * as z from 'zod';
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Textarea } from '@/components/ui/textarea';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { handleMacroShock, fetchPortfolioInsights } from '@/app/actions';
import type { SimulatePortfolioImpactOutput } from '@/ai/flows/portfolio-impact-of-macro-events';
import { useToast } from '@/hooks/use-toast';
import { Loader2, TrendingDown, ShieldHalf, Activity, Brain, Globe } from 'lucide-react';
import type { TavilySearchResponse } from '@/lib/tavily';
import PortfolioDrawdownChart from './portfolio-drawdown-chart';

const FormSchema = z.object({
  portfolioHoldings: z
    .string()
    .min(10, 'Please enter your portfolio holdings.'),
  macroEvent: z.string({ required_error: 'Please select a macro event.' }),
});

export function MacroShockSimulator({ portfolio }: { portfolio?: any } = {}) {
  const [result, setResult] = useState<SimulatePortfolioImpactOutput | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const [insights, setInsights] = useState<Record<string, TavilySearchResponse> | null>(null);
  const [isLoadingInsights, setIsLoadingInsights] = useState(false);
  const debounceTimeoutRef = useRef<NodeJS.Timeout | null>(null);
  const { toast } = useToast();

  const form = useForm<z.infer<typeof FormSchema>>({
    resolver: zodResolver(FormSchema),
    defaultValues: { portfolioHoldings: '' },
  });

  // Fetch insights when portfolio holdings are available
  const fetchInsights = async (holdingsText: string) => {
    if (!holdingsText || holdingsText.trim().length < 10) {
      setInsights(null);
      return;
    }

    setIsLoadingInsights(true);
    try {
      const res = await fetchPortfolioInsights(holdingsText);
      if (res.error) {
        console.error('Error fetching insights:', res.error);
        // Don't show error toast, just silently fail
      } else {
        setInsights(res.data as Record<string, TavilySearchResponse>);
      }
    } catch (error) {
      console.error('Error fetching insights:', error);
    } finally {
      setIsLoadingInsights(false);
    }
  };

  async function onSubmit(data: z.infer<typeof FormSchema>) {
    setIsLoading(true);
    setResult(null);

    // Fetch insights in parallel with simulation
    const holdingsText = portfolio 
      ? portfolio.holdings.map((h:any)=>`${h.companyId}: ${h.quantity}`).join(', ')
      : data.portfolioHoldings;
    fetchInsights(holdingsText);

    let res;
    if (portfolio?.id) {
      res = await handleMacroShock({ portfolioId: portfolio.id, macroEvent: data.macroEvent });
    } else {
      res = await handleMacroShock(data);
    }

    setIsLoading(false);

    const { data: simData, error } = res;
    if (error) {
      toast({
        variant: 'destructive',
        title: 'Error',
        description: error,
      });
    } else {
      setResult(simData);
    }
  }

  // Fetch insights when component mounts with portfolio
  useEffect(() => {
    if (portfolio?.holdings && portfolio.holdings.length > 0) {
      const holdingsText = portfolio.holdings.map((h:any)=>`${h.companyId}: ${h.quantity}`).join(', ');
      fetchInsights(holdingsText);
    }
    
    // Cleanup timeout on unmount
    return () => {
      if (debounceTimeoutRef.current) {
        clearTimeout(debounceTimeoutRef.current);
      }
    };
  }, [portfolio]);

  const parseDrawdown = (drawdown: string): number[] => {
    const numbers = drawdown.match(/\d+(\.\d+)?/g);
    return numbers ? numbers.map(Number) : [0,0];
  }

  return (
    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div className="lg:col-span-1">
        <Form {...form}>
          <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
            <FormField
              control={form.control}
              name="portfolioHoldings"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Portfolio Holdings</FormLabel>
                  <FormControl>
                    <Textarea
                      placeholder="e.g., RELIANCE: 20%, HDFCBANK: 15%, INFY: 10%"
                      className="min-h-[120px]"
                      {...field}
                      value={field.value || (portfolio ? portfolio.holdings.map((h:any)=>`${h.companyId}: ${h.quantity}`).join(', ') : '')}
                      onChange={(e) => {
                        field.onChange(e);
                        // Debounce insights fetching
                        if (debounceTimeoutRef.current) {
                          clearTimeout(debounceTimeoutRef.current);
                        }
                        debounceTimeoutRef.current = setTimeout(() => {
                          fetchInsights(e.target.value);
                        }, 1500);
                      }}
                    />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />
            <FormField
              control={form.control}
              name="macroEvent"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Macro Event</FormLabel>
                  <Select
                    onValueChange={field.onChange}
                    defaultValue={field.value}
                  >
                    <FormControl>
                      <SelectTrigger>
                        <SelectValue placeholder="Select an event to simulate" />
                      </SelectTrigger>
                    </FormControl>
                    <SelectContent>
                      <SelectItem value="RBI rate hike of 0.5%">
                        RBI rate hike of 0.5%
                      </SelectItem>
                      <SelectItem value="Oil price shock to $120/barrel">
                        Oil price shock to $120/barrel
                      </SelectItem>
                      <SelectItem value="10% INR depreciation vs USD">
                        10% INR depreciation vs USD
                      </SelectItem>
                    </SelectContent>
                  </Select>
                  <FormMessage />
                </FormItem>
              )}
            />
            <Button type="submit" disabled={isLoading} className="w-full bg-accent hover:bg-accent/90">
              {isLoading && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
              Simulate Impact
            </Button>
          </form>
        </Form>
      </div>
      <div className="lg:col-span-2">
        {isLoading && (
           <div className="flex items-center justify-center h-full min-h-[300px]">
                <div className="text-center">
                    <Loader2 className="mx-auto h-12 w-12 animate-spin text-primary" />
                    <p className="mt-4 text-muted-foreground">Running macro-shock simulation...</p>
                </div>
            </div>
        )}
        {result && (
          <div className="space-y-4">
            <div className="grid gap-4 sm:grid-cols-2">
                <Card>
                    <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                        <CardTitle className="text-sm font-medium">Expected Drawdown</CardTitle>
                        <TrendingDown className="h-4 w-4 text-muted-foreground" />
                    </CardHeader>
                    <CardContent>
                        <div className="text-2xl font-bold text-destructive">{result.expectedDrawdown}</div>
                        <p className="text-xs text-muted-foreground">Estimated portfolio value reduction</p>
                    </CardContent>
                </Card>
                <Card>
                    <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                        <CardTitle className="text-sm font-medium">Downside Risk</CardTitle>
                        <ShieldHalf className="h-4 w-4 text-muted-foreground" />
                    </CardHeader>
                    <CardContent>
                        {/* Safely handle missing or non-string downsideRisk */}
                        {typeof result.downsideRisk === 'string' && result.downsideRisk.trim() ? (
                          <div className="space-y-1">
                            {/* Try to extract a numeric value or key phrase at the start */}
                            {(() => {
                              const trimmed = result.downsideRisk.trim();
                              // Try to match a percentage or number at the start (e.g., "High", "15%", "10-15%", "Moderate (10-15%)")
                              const percentageMatch = trimmed.match(/^([0-9]+(?:\.[0-9]+)?\s*[-–—]\s*[0-9]+(?:\.[0-9]+)?%?|[0-9]+(?:\.[0-9]+)?%?|High|Medium|Moderate|Low)/i);
                              if (percentageMatch) {
                                const value = percentageMatch[1];
                                const rest = trimmed.substring(percentageMatch[0].length).trim();
                                return (
                                  <>
                                    <div className="text-2xl font-bold">{value}</div>
                                    {rest && <p className="text-xs text-muted-foreground">{rest}</p>}
                                  </>
                                );
                              }
                              // If no match, show first 3 words as value and rest as description
                              const words = trimmed.split(/\s+/);
                              if (words.length > 3) {
                                return (
                                  <>
                                    <div className="text-2xl font-bold">{words.slice(0, 3).join(' ')}</div>
                                    <p className="text-xs text-muted-foreground">{words.slice(3).join(' ')}</p>
                                  </>
                                );
                              }
                              // Show all as one line if short
                              return <div className="text-base font-semibold">{trimmed}</div>;
                            })()}
                          </div>
                        ) : (
                          <>
                            <div className="text-2xl font-bold text-muted-foreground">N/A</div>
                            <p className="text-xs text-muted-foreground">No downside risk provided</p>
                          </>
                        )}
                    </CardContent>
                </Card>
            </div>
            <Card>
              <CardHeader>
                  <CardTitle className="text-sm font-medium flex items-center gap-2">
                    <Activity className="h-4 w-4 text-muted-foreground" />
                    Sector Sensitivity
                  </CardTitle>
              </CardHeader>
              <CardContent>
                <p className="text-sm text-muted-foreground">{result.sectorSensitivity}</p>
                <div className="h-[200px] mt-4">
                    <PortfolioDrawdownChart drawdownRange={parseDrawdown(result.expectedDrawdown)} />
                </div>
              </CardContent>
            </Card>

            {/* Reasoning card - Always show when we have a result */}
            <Card>
              <CardHeader>
                <CardTitle className="text-sm font-medium flex items-center gap-2">
                  <Brain className="h-4 w-4 text-muted-foreground" />
                  Analysis & Reasoning
                </CardTitle>
                <CardDescription>
                  Detailed analysis of the macro shock impact on your portfolio
                </CardDescription>
              </CardHeader>
              <CardContent>
                {result.reasoning && result.reasoning.trim() ? (
                  <div className="prose prose-sm max-w-none">
                    <p className="text-sm text-foreground whitespace-pre-wrap leading-relaxed">
                      {result.reasoning}
                    </p>
                  </div>
                ) : (
                  <div className="text-sm text-muted-foreground">
                    No detailed reasoning available. Check the console for raw model output.
                  </div>
                )}
              </CardContent>
            </Card>

            {/* Suggested action card (if model provided a recommendation) */}
            {result.suggestedAction && ( 
              <Card>
                <CardHeader>
                  <CardTitle className="text-sm font-medium">Suggested Action</CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="text-sm font-semibold">{result.suggestedAction.action}</div>
                  <p className="text-sm text-muted-foreground mt-2">{result.suggestedAction.details}</p>
                </CardContent>
              </Card>
            )}
          </div>
        )}

        {/* Web Insights Card - Always visible when insights are available */}
        {(insights || isLoadingInsights) && (
          <Card className="mt-4">
            <CardHeader>
              <CardTitle className="text-sm font-medium flex items-center gap-2">
                <Globe className="h-4 w-4 text-muted-foreground" />
                Web Insights for Portfolio Holdings
              </CardTitle>
              <CardDescription>
                Real-time news and insights from the web for companies in your portfolio
              </CardDescription>
            </CardHeader>
            <CardContent>
              {isLoadingInsights ? (
                <div className="flex items-center justify-center py-8">
                  <Loader2 className="h-6 w-6 animate-spin text-primary mr-2" />
                  <p className="text-sm text-muted-foreground">Fetching web insights...</p>
                </div>
              ) : insights && Object.keys(insights).length > 0 ? (
                <div className="space-y-6">
                  {Object.entries(insights).map(([companyName, searchResults]) => (
                    <div key={companyName} className="border-b last:border-0 pb-4 last:pb-0">
                      <h4 className="font-semibold text-base mb-3">{companyName}</h4>
                      
                      {searchResults.answer && (
                        <div className="mb-3 p-3 bg-muted/50 rounded-md">
                          <p className="text-sm font-medium mb-1">Summary:</p>
                          <p className="text-sm text-muted-foreground">{searchResults.answer}</p>
                        </div>
                      )}

                      {searchResults.results && searchResults.results.length > 0 && (
                        <div className="space-y-3">
                          <p className="text-sm font-medium">Recent News & Insights:</p>
                          {searchResults.results.slice(0, 3).map((result, index) => (
                            <div key={index} className="p-3 border rounded-md hover:bg-muted/50 transition-colors">
                              <a 
                                href={result.url} 
                                target="_blank" 
                                rel="noopener noreferrer"
                                className="text-sm font-medium text-primary hover:underline block mb-1"
                              >
                                {result.title}
                              </a>
                              <p className="text-xs text-muted-foreground mb-2 line-clamp-2">
                                {result.content}
                              </p>
                              <div className="flex items-center gap-2 text-xs text-muted-foreground">
                                <span className="truncate">{new URL(result.url).hostname}</span>
                                {result.published_date && (
                                  <>
                                    <span>•</span>
                                    <span>{new Date(result.published_date).toLocaleDateString()}</span>
                                  </>
                                )}
                              </div>
                            </div>
                          ))}
                        </div>
                      )}

                      {(!searchResults.results || searchResults.results.length === 0) && !searchResults.answer && (
                        <p className="text-sm text-muted-foreground">No insights available for this company.</p>
                      )}
                    </div>
                  ))}
                </div>
              ) : (
                <p className="text-sm text-muted-foreground">No insights available. Please enter portfolio holdings to fetch insights.</p>
              )}
            </CardContent>
          </Card>
        )}

         {!isLoading && !result && (
            <div className="flex items-center justify-center h-full min-h-[300px] border-2 border-dashed rounded-lg">
                <p className="text-muted-foreground">Fill the form to simulate portfolio impact.</p>
            </div>
        )}
      </div>
    </div>
  );
}
</file>

<file path="src/components/features/management-trust-score.tsx">
'use client';
import { useState, useRef } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import * as z from 'zod';
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Card, CardContent } from '@/components/ui/card';
import { Separator } from '@/components/ui/separator';
import { handleManagementTrustScore } from '@/app/actions';
import type { ManagementTrustScoreOutput } from '@/ai/flows/management-trust-score';
import { useToast } from '@/hooks/use-toast';
import { Loader2, ExternalLink, Upload } from 'lucide-react';
import { PieChart, Pie, Cell, ResponsiveContainer } from 'recharts';

const FormSchema = z.object({
  companyName: z.string().min(2, 'Company name must be at least 2 characters.'),
  financialReport: z
    .any()
    .refine((files) => files?.length === 1, 'File is required.')
    .refine((files) => files?.[0]?.type === 'text/plain', 'Only .txt files are allowed.'),
});

const TrustScoreGauge = ({ score }: { score: number }) => {
    const data = [
        { name: 'Score', value: score },
        { name: 'Remaining', value: 100 - score },
    ];
    const color = score > 75 ? 'hsl(var(--chart-2))' : score > 40 ? 'hsl(var(--chart-4))' : 'hsl(var(--destructive))';

    return (
        <div className="relative w-40 h-40">
            <ResponsiveContainer width="100%" height="100%">
                <PieChart>
                    <Pie
                        data={data}
                        cx="50%"
                        cy="50%"
                        startAngle={180}
                        endAngle={-180}
                        innerRadius="70%"
                        outerRadius="100%"
                        dataKey="value"
                        stroke="none"
                        cornerRadius={5}
                    >
                        <Cell fill={color} />
                        <Cell fill="hsl(var(--muted))" />
                    </Pie>
                </PieChart>
            </ResponsiveContainer>
            <div className="absolute inset-0 flex flex-col items-center justify-center">
                <span className="text-4xl font-bold font-headline" style={{ color }}>{score}</span>
                <span className="text-xs text-muted-foreground">out of 100</span>
            </div>
        </div>
    );
};


export function ManagementTrustScore({ portfolio }: { portfolio?: any } = {}) {
  const [result, setResult] = useState<ManagementTrustScoreOutput | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const [fileName, setFileName] = useState('');
  const { toast } = useToast();

  const form = useForm<z.infer<typeof FormSchema>>({
    resolver: zodResolver(FormSchema),
    defaultValues: { companyName: '' },
  });

  const fileRef = form.register('financialReport');

  const readFileAsText = (file: File): Promise<string> => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (event) => {
        if (event.target?.result) {
          resolve(event.target.result as string);
        } else {
          reject(new Error('Failed to read file.'));
        }
      };
      reader.onerror = () => {
        reject(new Error('Error reading file.'));
      };
      reader.readAsText(file);
    });
  };

  async function onSubmit(data: z.infer<typeof FormSchema>) {
    setIsLoading(true);
    setResult(null);

    try {
      const file = data.financialReport?.[0];
      const fileContent = file ? await readFileAsText(file) : '';

      let body: any;
      if (portfolio?.id) {
        body = { task: 'managementTrustScore', input: { portfolioId: portfolio.id } };
      } else {
        body = { task: 'managementTrustScore', input: { companyName: data.companyName, financialData: fileContent ? [fileContent] : [] } };
      }

      const res = await fetch('/api/insights', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });
      const json = await res.json();
      if (!res.ok) {
        toast({ variant: 'destructive', title: 'Error', description: json?.error || 'Unknown error' });
      } else {
        try {
          const parsed = JSON.parse(json.text);
          setResult(parsed);
        } catch (e: any) {
          toast({ variant: 'destructive', title: 'Error parsing response', description: e.message || 'Invalid JSON returned from model.' });
        }
      }
    } catch (e: any) {
        toast({
            variant: 'destructive',
            title: 'Error reading file',
            description: e.message || 'Could not process the uploaded file.',
        });
    } finally {
        setIsLoading(false);
    }
  }

  return (
    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div className="lg:col-span-1">
        <Form {...form}>
          <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
            <FormField
              control={form.control}
              name="companyName"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Company Name</FormLabel>
                  <FormControl>
                    <Input placeholder="e.g., Reliance Industries" {...field} />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />
            <FormField
              control={form.control}
              name="financialReport"
              render={() => (
                <FormItem>
                  <FormLabel>Financial Report</FormLabel>
                  <FormControl>
                    <>
                      <Button
                        type="button"
                        variant="outline"
                        className="w-full justify-start text-muted-foreground"
                        onClick={() => document.getElementById('file-upload')?.click()}
                      >
                        <Upload className="mr-2 h-4 w-4" />
                        {fileName || 'Upload a .txt file'}
                      </Button>
                      <Input
                        type="file"
                        id="file-upload"
                        className="hidden"
                        accept=".txt"
                        {...fileRef}
                        onChange={(e) => {
                          if (e.target.files && e.target.files.length > 0) {
                            setFileName(e.target.files[0].name);
                          } else {
                            setFileName('');
                          }
                          // Manually trigger react-hook-form change
                          fileRef.onChange(e);
                        }}
                      />
                    </>
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />
            <Button type="submit" disabled={isLoading} className="w-full bg-accent hover:bg-accent/90">
              {isLoading && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
              Calculate Trust Score
            </Button>
          </form>
        </Form>
      </div>
      <div className="lg:col-span-2">
        {isLoading && (
            <div className="flex items-center justify-center h-full min-h-[300px]">
                <div className="text-center">
                    <Loader2 className="mx-auto h-12 w-12 animate-spin text-primary" />
                    <p className="mt-4 text-muted-foreground">Analyzing management commitments...</p>
                </div>
            </div>
        )}
        {result && (
          <Card>
            <CardContent className="p-6">
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 items-center">
                    <div className="flex justify-center md:col-span-1">
                        <TrustScoreGauge score={result.managementTrustScore} />
                    </div>
                    <div className="md:col-span-2 space-y-4">
                        <h3 className="text-lg font-semibold font-headline">Reasoning</h3>
                        <p className="text-sm text-muted-foreground">{result.reasoning}</p>
                    </div>
                </div>
                <Separator className="my-6" />
                <div>
                  <h3 className="text-lg font-semibold font-headline mb-4">Traceable Insights</h3>
                  <div className="space-y-3 max-h-60 overflow-y-auto pr-2">
                    {result.citations.map((citation, index) => (
                      <div key={index} className="text-sm p-3 bg-secondary/50 rounded-md">
                        <p className="italic">"{citation.text}"</p>
                        <a href={citation.source} target="_blank" rel="noopener noreferrer" className="mt-1 text-xs text-accent-foreground/80 hover:text-accent-foreground inline-flex items-center gap-1">
                          Source <ExternalLink className="h-3 w-3" />
                        </a>
                      </div>
                    ))}
                  </div>
                </div>
            </CardContent>
          </Card>
        )}
        {!isLoading && !result && (
            <div className="flex items-center justify-center h-full min-h-[300px] border-2 border-dashed rounded-lg">
                <p className="text-muted-foreground">Enter a company and upload a report to see its trust score.</p>
            </div>
        )}
      </div>
    </div>
  );
}
</file>

<file path="src/components/features/portfolio-drawdown-chart.tsx">
'use client'

import { Bar, BarChart, CartesianGrid, ResponsiveContainer, XAxis, YAxis, Tooltip, Cell } from 'recharts';
import { ChartContainer, ChartTooltipContent } from '@/components/ui/chart';

interface PortfolioDrawdownChartProps {
    drawdownRange: number[];
}

// Placeholder data for sectors. In a real application, this would come from the AI.
const sectorData = [
    { sector: 'IT', impact: -8.5 },
    { sector: 'Finance', impact: -12.2 },
    { sector: 'FMCG', impact: -4.1 },
    { sector: 'Auto', impact: -15.8 },
    { sector: 'Pharma', impact: -3.5 },
];

const chartConfig = {
    value: {
      label: "Impact",
    },
};

export default function PortfolioDrawdownChart({ drawdownRange }: PortfolioDrawdownChartProps) {
    const averageDrawdown = (drawdownRange[0] + (drawdownRange[1] || drawdownRange[0])) / 2;

    const chartData = sectorData.map(d => ({
        name: d.sector,
        value: d.impact,
    }));

    return (
        <ChartContainer config={chartConfig} className="h-full w-full">
            <BarChart data={chartData} margin={{ top: 5, right: 20, left: -10, bottom: 5 }} accessibilityLayer>
                <CartesianGrid strokeDasharray="3 3" vertical={false} />
                <XAxis 
                    dataKey="name" 
                    tickLine={false} 
                    axisLine={false}
                    tick={{ fontSize: '10pt' }}
                />
                <YAxis
                    tickLine={false}
                    axisLine={false}
                    tick={{ fontSize: '10pt' }}
                    tickFormatter={(value) => `${value}%`}
                />
                <Tooltip
                    cursor={{ fill: 'hsl(var(--muted))' }}
                    content={<ChartTooltipContent />}
                />
                <Bar dataKey="value" name="Impact" unit="%">
                    {chartData.map((entry, index) => (
                        <Cell key={`cell-${index}`} fill={entry.value < -10 ? 'hsl(var(--destructive))' : 'hsl(var(--chart-4))'} />
                    ))}
                </Bar>
            </BarChart>
        </ChartContainer>
    );
}
</file>

<file path="src/components/features/risk-factor-summary.tsx">
'use client';

import { useState } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import * as z from 'zod';
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { Card, CardContent } from '@/components/ui/card';
import { handleRiskSummary } from '@/app/actions';
import type { SummarizeRiskFactorsOutput } from '@/ai/flows/summarize-risk-factors';
import { useToast } from '@/hooks/use-toast';
import { Loader2 } from 'lucide-react';
import { ScrollArea } from '../ui/scroll-area';

const FormSchema = z.object({
  companyName: z.string().min(2, 'Company name is required.'),
  financialReport: z.string().min(50, 'Report text is too short.'),
});

const defaultReportText = `Risk Factors for Fictional Auto Co.

1. Market and Economic Risks:
Our business is highly dependent on the automotive industry, which is subject to market cycles. Economic downturns, rising interest rates, and reduced consumer spending can adversely affect demand for our products. Competition in the EV space is intensifying with new entrants, which may impact our market share and profitability.

2. Operational Risks:
We rely on a global supply chain for key components like batteries and semiconductors. Disruptions due to geopolitical events, trade disputes, or pandemics can halt production. Our manufacturing processes are complex and any failure could lead to significant delays and costs.

3. Regulatory Risks:
Our operations are subject to stringent environmental and safety regulations. Changes in these regulations could require costly modifications to our vehicles and manufacturing facilities. We may also face significant penalties for non-compliance.
`;

export function RiskFactorSummary({ portfolio }: { portfolio?: any } = {}) {
  const [result, setResult] = useState<SummarizeRiskFactorsOutput | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const { toast } = useToast();

  const form = useForm<z.infer<typeof FormSchema>>({
    resolver: zodResolver(FormSchema),
    defaultValues: {
      companyName: 'Fictional Auto Co.',
      financialReport: defaultReportText,
    },
  });

  async function onSubmit(data: z.infer<typeof FormSchema>) {
    setIsLoading(true);
    setResult(null);

    let res;
    if (portfolio?.id) {
      res = await handleRiskSummary({ portfolioId: portfolio.id });
    } else {
      res = await handleRiskSummary(data);
    }

    const { data: summaryData, error } = res;
    setIsLoading(false);

    if (error) {
      toast({
        variant: 'destructive',
        title: 'Error',
        description: error,
      });
    } else {
      setResult(summaryData);
    }
  }

  return (
    <div className="space-y-4">
      <Form {...form}>
        <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
          <FormField
            control={form.control}
            name="companyName"
            render={({ field }) => (
              <FormItem>
                <FormLabel>Company Name</FormLabel>
                <FormControl>
                  <Input {...field} />
                </FormControl>
                <FormMessage />
              </FormItem>
            )}
          />
          <FormField
            control={form.control}
            name="financialReport"
            render={({ field }) => (
              <FormItem>
                <FormLabel>Financial Report Text</FormLabel>
                <FormControl>
                  <Textarea className="min-h-[150px] text-xs" {...field} />
                </FormControl>
                <FormMessage />
              </FormItem>
            )}
          />
          <Button type="submit" disabled={isLoading} className="w-full bg-accent hover:bg-accent/90">
            {isLoading && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
            Summarize Risks
          </Button>
        </form>
      </Form>

      {isLoading && (
         <div className="flex items-center justify-center h-full min-h-[150px]">
              <div className="text-center">
                  <Loader2 className="mx-auto h-8 w-8 animate-spin text-primary" />
                  <p className="mt-2 text-muted-foreground text-sm">Summarizing risk factors...</p>
              </div>
          </div>
      )}
      {result && (
        <Card>
          <CardContent className="p-4">
            <ScrollArea className="h-48">
              <ul className="text-xs text-muted-foreground list-disc pl-5 space-y-2">
                {result.riskFactorSummary.map((item, index) => (
                  <li key={index}>{item}</li>
                ))}
              </ul>
            </ScrollArea>
          </CardContent>
        </Card>
      )}
       {!isLoading && !result && (
          <div className="flex items-center justify-center h-full min-h-[150px] border-2 border-dashed rounded-lg">
              <p className="text-muted-foreground text-sm">Submit a report to see risk summary.</p>
          </div>
      )}
    </div>
  );
}
</file>

<file path="src/components/ui/sidebar.tsx">
"use client"

import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { VariantProps, cva } from "class-variance-authority"
import { PanelLeft } from "lucide-react"

import { useIsMobile } from "@/hooks/use-mobile"
import { cn } from "@/lib/utils"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Separator } from "@/components/ui/separator"
import { Sheet, SheetContent, SheetTitle } from "@/components/ui/sheet"
import { Skeleton } from "@/components/ui/skeleton"
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from "@/components/ui/tooltip"

const SIDEBAR_COOKIE_NAME = "sidebar_state"
const SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7
const SIDEBAR_WIDTH = "16rem"
const SIDEBAR_WIDTH_MOBILE = "18rem"
const SIDEBAR_WIDTH_ICON = "3rem"
const SIDEBAR_KEYBOARD_SHORTCUT = "b"

type SidebarContext = {
  state: "expanded" | "collapsed"
  open: boolean
  setOpen: (open: boolean) => void
  openMobile: boolean
  setOpenMobile: (open: boolean) => void
  isMobile: boolean
  toggleSidebar: () => void
}

const SidebarContext = React.createContext<SidebarContext | null>(null)

function useSidebar() {
  const context = React.useContext(SidebarContext)
  if (!context) {
    throw new Error("useSidebar must be used within a SidebarProvider.")
  }

  return context
}

const SidebarProvider = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> & {
    defaultOpen?: boolean
    open?: boolean
    onOpenChange?: (open: boolean) => void
  }
>(
  (
    {
      defaultOpen = true,
      open: openProp,
      onOpenChange: setOpenProp,
      className,
      style,
      children,
      ...props
    },
    ref
  ) => {
    const isMobile = useIsMobile()
    const [openMobile, setOpenMobile] = React.useState(false)

    // This is the internal state of the sidebar.
    // We use openProp and setOpenProp for control from outside the component.
    const [_open, _setOpen] = React.useState(defaultOpen)
    const open = openProp ?? _open
    const setOpen = React.useCallback(
      (value: boolean | ((value: boolean) => boolean)) => {
        const openState = typeof value === "function" ? value(open) : value
        if (setOpenProp) {
          setOpenProp(openState)
        } else {
          _setOpen(openState)
        }

        // This sets the cookie to keep the sidebar state.
        document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`
      },
      [setOpenProp, open]
    )

    // Helper to toggle the sidebar.
    const toggleSidebar = React.useCallback(() => {
      return isMobile
        ? setOpenMobile((open) => !open)
        : setOpen((open) => !open)
    }, [isMobile, setOpen, setOpenMobile])

    // Adds a keyboard shortcut to toggle the sidebar.
    React.useEffect(() => {
      const handleKeyDown = (event: KeyboardEvent) => {
        if (
          event.key === SIDEBAR_KEYBOARD_SHORTCUT &&
          (event.metaKey || event.ctrlKey)
        ) {
          event.preventDefault()
          toggleSidebar()
        }
      }

      window.addEventListener("keydown", handleKeyDown)
      return () => window.removeEventListener("keydown", handleKeyDown)
    }, [toggleSidebar])

    // We add a state so that we can do data-state="expanded" or "collapsed".
    // This makes it easier to style the sidebar with Tailwind classes.
    const state = open ? "expanded" : "collapsed"

    const contextValue = React.useMemo<SidebarContext>(
      () => ({
        state,
        open,
        setOpen,
        isMobile,
        openMobile,
        setOpenMobile,
        toggleSidebar,
      }),
      [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]
    )

    return (
      <SidebarContext.Provider value={contextValue}>
        <TooltipProvider delayDuration={0}>
          <div
            style={
              {
                "--sidebar-width": SIDEBAR_WIDTH,
                "--sidebar-width-icon": SIDEBAR_WIDTH_ICON,
                ...style,
              } as React.CSSProperties
            }
            className={cn(
              "group/sidebar-wrapper flex min-h-svh w-full has-[[data-variant=inset]]:bg-sidebar",
              className
            )}
            ref={ref}
            {...props}
          >
            {children}
          </div>
        </TooltipProvider>
      </SidebarContext.Provider>
    )
  }
)
SidebarProvider.displayName = "SidebarProvider"

const Sidebar = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> & {
    side?: "left" | "right"
    variant?: "sidebar" | "floating" | "inset"
    collapsible?: "offcanvas" | "icon" | "none"
  }
>(
  (
    {
      side = "left",
      variant = "sidebar",
      collapsible = "offcanvas",
      className,
      children,
      ...props
    },
    ref
  ) => {
    const { isMobile, state, openMobile, setOpenMobile } = useSidebar()

    if (collapsible === "none") {
      return (
        <div
          className={cn(
            "flex h-full w-[--sidebar-width] flex-col bg-sidebar text-sidebar-foreground",
            className
          )}
          ref={ref}
          {...props}
        >
          {children}
        </div>
      )
    }

    if (isMobile) {
      return (
        <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>
          <SheetContent
            data-sidebar="sidebar"
            data-mobile="true"
            className="w-[--sidebar-width] bg-sidebar p-0 text-sidebar-foreground [&>button]:hidden"
            style={
              {
                "--sidebar-width": SIDEBAR_WIDTH_MOBILE,
              } as React.CSSProperties
            }
            side={side}
          >
            <SheetTitle className="sr-only">Navigation Sidebar</SheetTitle>
            <div className="flex h-full w-full flex-col">{children}</div>
          </SheetContent>
        </Sheet>
      )
    }

    return (
      <div
        ref={ref}
        className="group peer hidden md:block text-sidebar-foreground"
        data-state={state}
        data-collapsible={state === "collapsed" ? collapsible : ""}
        data-variant={variant}
        data-side={side}
      >
        {/* This is what handles the sidebar gap on desktop */}
        <div
          className={cn(
            "duration-200 relative h-svh w-[--sidebar-width] bg-transparent transition-[width] ease-linear",
            "group-data-[collapsible=offcanvas]:w-0",
            "group-data-[side=right]:rotate-180",
            variant === "floating" || variant === "inset"
              ? "group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4))]"
              : "group-data-[collapsible=icon]:w-[--sidebar-width-icon]"
          )}
        />
        <div
          className={cn(
            "duration-200 fixed inset-y-0 z-10 hidden h-svh w-[--sidebar-width] transition-[left,right,width] ease-linear md:flex",
            side === "left"
              ? "left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]"
              : "right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]",
            // Adjust the padding for floating and inset variants.
            variant === "floating" || variant === "inset"
              ? "p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4)_+2px)]"
              : "group-data-[collapsible=icon]:w-[--sidebar-width-icon] group-data-[side=left]:border-r group-data-[side=right]:border-l",
            className
          )}
          {...props}
        >
          <div
            data-sidebar="sidebar"
            className="flex h-full w-full flex-col bg-sidebar group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:border-sidebar-border group-data-[variant=floating]:shadow"
          >
            {children}
          </div>
        </div>
      </div>
    )
  }
)
Sidebar.displayName = "Sidebar"

const SidebarTrigger = React.forwardRef<
  React.ElementRef<typeof Button>,
  React.ComponentProps<typeof Button>
>(({ className, onClick, ...props }, ref) => {
  const { toggleSidebar } = useSidebar()

  return (
    <Button
      ref={ref}
      data-sidebar="trigger"
      variant="ghost"
      size="icon"
      className={cn("h-7 w-7", className)}
      onClick={(event) => {
        onClick?.(event)
        toggleSidebar()
      }}
      {...props}
    >
      <PanelLeft />
      <span className="sr-only">Toggle Sidebar</span>
    </Button>
  )
})
SidebarTrigger.displayName = "SidebarTrigger"

const SidebarRail = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<"button">
>(({ className, ...props }, ref) => {
  const { toggleSidebar } = useSidebar()

  return (
    <button
      ref={ref}
      data-sidebar="rail"
      aria-label="Toggle Sidebar"
      tabIndex={-1}
      onClick={toggleSidebar}
      title="Toggle Sidebar"
      className={cn(
        "absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] hover:after:bg-sidebar-border group-data-[side=left]:-right-4 group-data-[side=right]:left-0 sm:flex",
        "[[data-side=left]_&]:cursor-w-resize [[data-side=right]_&]:cursor-e-resize",
        "[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize",
        "group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full group-data-[collapsible=offcanvas]:hover:bg-sidebar",
        "[[data-side=left][data-collapsible=offcanvas]_&]:-right-2",
        "[[data-side=right][data-collapsible=offcanvas]_&]:-left-2",
        className
      )}
      {...props}
    />
  )
})
SidebarRail.displayName = "SidebarRail"

const SidebarInset = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"main">
>(({ className, ...props }, ref) => {
  return (
    <main
      ref={ref}
      className={cn(
        "relative flex min-h-svh flex-1 flex-col bg-background",
        "peer-data-[variant=inset]:min-h-[calc(100svh-theme(spacing.4))] md:peer-data-[variant=inset]:m-2 md:peer-data-[state=collapsed]:peer-data-[variant=inset]:ml-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow",
        className
      )}
      {...props}
    />
  )
})
SidebarInset.displayName = "SidebarInset"

const SidebarInput = React.forwardRef<
  React.ElementRef<typeof Input>,
  React.ComponentProps<typeof Input>
>(({ className, ...props }, ref) => {
  return (
    <Input
      ref={ref}
      data-sidebar="input"
      className={cn(
        "h-8 w-full bg-background shadow-none focus-visible:ring-2 focus-visible:ring-sidebar-ring",
        className
      )}
      {...props}
    />
  )
})
SidebarInput.displayName = "SidebarInput"

const SidebarHeader = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div">
>(({ className, ...props }, ref) => {
  return (
    <div
      ref={ref}
      data-sidebar="header"
      className={cn("flex flex-col gap-2 p-2", className)}
      {...props}
    />
  )
})
SidebarHeader.displayName = "SidebarHeader"

const SidebarFooter = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div">
>(({ className, ...props }, ref) => {
  return (
    <div
      ref={ref}
      data-sidebar="footer"
      className={cn("flex flex-col gap-2 p-2", className)}
      {...props}
    />
  )
})
SidebarFooter.displayName = "SidebarFooter"

const SidebarSeparator = React.forwardRef<
  React.ElementRef<typeof Separator>,
  React.ComponentProps<typeof Separator>
>(({ className, ...props }, ref) => {
  return (
    <Separator
      ref={ref}
      data-sidebar="separator"
      className={cn("mx-2 w-auto bg-sidebar-border", className)}
      {...props}
    />
  )
})
SidebarSeparator.displayName = "SidebarSeparator"

const SidebarContent = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div">
>(({ className, ...props }, ref) => {
  return (
    <div
      ref={ref}
      data-sidebar="content"
      className={cn(
        "flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden",
        className
      )}
      {...props}
    />
  )
})
SidebarContent.displayName = "SidebarContent"

const SidebarGroup = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div">
>(({ className, ...props }, ref) => {
  return (
    <div
      ref={ref}
      data-sidebar="group"
      className={cn("relative flex w-full min-w-0 flex-col p-2", className)}
      {...props}
    />
  )
})
SidebarGroup.displayName = "SidebarGroup"

const SidebarGroupLabel = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> & { asChild?: boolean }
>(({ className, asChild = false, ...props }, ref) => {
  const Comp = asChild ? Slot : "div"

  return (
    <Comp
      ref={ref}
      data-sidebar="group-label"
      className={cn(
        "duration-200 flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium text-sidebar-foreground/70 outline-none ring-sidebar-ring transition-[margin,opa] ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0",
        "group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0",
        className
      )}
      {...props}
    />
  )
})
SidebarGroupLabel.displayName = "SidebarGroupLabel"

const SidebarGroupAction = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<"button"> & { asChild?: boolean }
>(({ className, asChild = false, ...props }, ref) => {
  const Comp = asChild ? Slot : "button"

  return (
    <Comp
      ref={ref}
      data-sidebar="group-action"
      className={cn(
        "absolute right-3 top-3.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0",
        // Increases the hit area of the button on mobile.
        "after:absolute after:-inset-2 after:md:hidden",
        "group-data-[collapsible=icon]:hidden",
        className
      )}
      {...props}
    />
  )
})
SidebarGroupAction.displayName = "SidebarGroupAction"

const SidebarGroupContent = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div">
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    data-sidebar="group-content"
    className={cn("w-full text-sm", className)}
    {...props}
  />
))
SidebarGroupContent.displayName = "SidebarGroupContent"

const SidebarMenu = React.forwardRef<
  HTMLUListElement,
  React.ComponentProps<"ul">
>(({ className, ...props }, ref) => (
  <ul
    ref={ref}
    data-sidebar="menu"
    className={cn("flex w-full min-w-0 flex-col gap-1", className)}
    {...props}
  />
))
SidebarMenu.displayName = "SidebarMenu"

const SidebarMenuItem = React.forwardRef<
  HTMLLIElement,
  React.ComponentProps<"li">
>(({ className, ...props }, ref) => (
  <li
    ref={ref}
    data-sidebar="menu-item"
    className={cn("group/menu-item relative", className)}
    {...props}
  />
))
SidebarMenuItem.displayName = "SidebarMenuItem"

const sidebarMenuButtonVariants = cva(
  "peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-none ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-[[data-sidebar=menu-action]]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:!size-8 group-data-[collapsible=icon]:!p-2 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0",
  {
    variants: {
      variant: {
        default: "hover:bg-sidebar-accent hover:text-sidebar-accent-foreground",
        outline:
          "bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]",
      },
      size: {
        default: "h-8 text-sm",
        sm: "h-7 text-xs",
        lg: "h-12 text-sm group-data-[collapsible=icon]:!p-0",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

const SidebarMenuButton = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<"button"> & {
    asChild?: boolean
    isActive?: boolean
    tooltip?: string | React.ComponentProps<typeof TooltipContent>
  } & VariantProps<typeof sidebarMenuButtonVariants> & { href?: string }
>(
  (
    {
      asChild = false,
      isActive = false,
      variant = "default",
      size = "default",
      tooltip,
      className,
      ...props
    },
    ref
  ) => {
    const Comp = asChild ? Slot : "button"
    const { isMobile, state } = useSidebar()

    const button = (
      <Comp
        ref={ref}
        data-sidebar="menu-button"
        data-size={size}
        data-active={isActive}
        className={cn(sidebarMenuButtonVariants({ variant, size }), className)}
        {...props}
      />
    )

    if (!tooltip) {
      return button
    }

    if (typeof tooltip === "string") {
      tooltip = {
        children: tooltip,
      }
    }

    return (
      <Tooltip>
        <TooltipTrigger asChild>{button}</TooltipTrigger>
        <TooltipContent
          side="right"
          align="center"
          hidden={state !== "collapsed" || isMobile}
          {...tooltip}
        />
      </Tooltip>
    )
  }
)
SidebarMenuButton.displayName = "SidebarMenuButton"

const SidebarMenuAction = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<"button"> & {
    asChild?: boolean
    showOnHover?: boolean
  }
>(({ className, asChild = false, showOnHover = false, ...props }, ref) => {
  const Comp = asChild ? Slot : "button"

  return (
    <Comp
      ref={ref}
      data-sidebar="menu-action"
      className={cn(
        "absolute right-1 top-1.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 peer-hover/menu-button:text-sidebar-accent-foreground [&>svg]:size-4 [&>svg]:shrink-0",
        // Increases the hit area of the button on mobile.
        "after:absolute after:-inset-2 after:md:hidden",
        "peer-data-[size=sm]/menu-button:top-1",
        "peer-data-[size=default]/menu-button:top-1.5",
        "peer-data-[size=lg]/menu-button:top-2.5",
        "group-data-[collapsible=icon]:hidden",
        showOnHover &&
          "group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 peer-data-[active=true]/menu-button:text-sidebar-accent-foreground md:opacity-0",
        className
      )}
      {...props}
    />
  )
})
SidebarMenuAction.displayName = "SidebarMenuAction"

const SidebarMenuBadge = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div">
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    data-sidebar="menu-badge"
    className={cn(
      "absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums text-sidebar-foreground select-none pointer-events-none",
      "peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground",
      "peer-data-[size=sm]/menu-button:top-1",
      "peer-data-[size=default]/menu-button:top-1.5",
      "peer-data-[size=lg]/menu-button:top-2.5",
      "group-data-[collapsible=icon]:hidden",
      className
    )}
    {...props}
  />
))
SidebarMenuBadge.displayName = "SidebarMenuBadge"

const SidebarMenuSkeleton = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> & {
    showIcon?: boolean
  }
>(({ className, showIcon = false, ...props }, ref) => {
  // Use a stable width to avoid hydration mismatches
  // In a real app, you might want to use different widths per instance
  const width = React.useMemo(() => {
    return '70%'
  }, [])

  return (
    <div
      ref={ref}
      data-sidebar="menu-skeleton"
      className={cn("rounded-md h-8 flex gap-2 px-2 items-center", className)}
      {...props}
    >
      {showIcon && (
        <Skeleton
          className="size-4 rounded-md"
          data-sidebar="menu-skeleton-icon"
        />
      )}
      <Skeleton
        className="h-4 flex-1 max-w-[--skeleton-width]"
        data-sidebar="menu-skeleton-text"
        style={
          {
            "--skeleton-width": width,
          } as React.CSSProperties
        }
      />
    </div>
  )
})
SidebarMenuSkeleton.displayName = "SidebarMenuSkeleton"

const SidebarMenuSub = React.forwardRef<
  HTMLUListElement,
  React.ComponentProps<"ul">
>(({ className, ...props }, ref) => (
  <ul
    ref={ref}
    data-sidebar="menu-sub"
    className={cn(
      "mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l border-sidebar-border px-2.5 py-0.5",
      "group-data-[collapsible=icon]:hidden",
      className
    )}
    {...props}
  />
))
SidebarMenuSub.displayName = "SidebarMenuSub"

const SidebarMenuSubItem = React.forwardRef<
  HTMLLIElement,
  React.ComponentProps<"li">
>(({ ...props }, ref) => <li ref={ref} {...props} />)
SidebarMenuSubItem.displayName = "SidebarMenuSubItem"

const SidebarMenuSubButton = React.forwardRef<
  HTMLAnchorElement,
  React.ComponentProps<"a"> & {
    asChild?: boolean
    size?: "sm" | "md"
    isActive?: boolean
  }
>(({ asChild = false, size = "md", isActive, className, ...props }, ref) => {
  const Comp = asChild ? Slot : "a"

  return (
    <Comp
      ref={ref}
      data-sidebar="menu-sub-button"
      data-size={size}
      data-active={isActive}
      className={cn(
        "flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 text-sidebar-foreground outline-none ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 [&>svg]:text-sidebar-accent-foreground",
        "data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground",
        size === "sm" && "text-xs",
        size === "md" && "text-sm",
        "group-data-[collapsible=icon]:hidden",
        className
      )}
      {...props}
    />
  )
})
SidebarMenuSubButton.displayName = "SidebarMenuSubButton"

export {
  Sidebar,
  SidebarContent,
  SidebarFooter,
  SidebarGroup,
  SidebarGroupAction,
  SidebarGroupContent,
  SidebarGroupLabel,
  SidebarHeader,
  SidebarInput,
  SidebarInset,
  SidebarMenu,
  SidebarMenuAction,
  SidebarMenuBadge,
  SidebarMenuButton,
  SidebarMenuItem,
  SidebarMenuSkeleton,
  SidebarMenuSub,
  SidebarMenuSubButton,
  SidebarMenuSubItem,
  SidebarProvider,
  SidebarRail,
  SidebarSeparator,
  SidebarTrigger,
  useSidebar,
}
</file>

<file path="package.json">
{
  "name": "clearfinanceai-app",
  "version": "0.0.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start"
  },
  "dependencies": {
    "@google-cloud/storage": "^7.18.0",
    "@google-cloud/vertexai": "^1.10.0",
    "@google/generative-ai": "^0.24.1",
    "@hookform/resolvers": "^5.2.2",
    "@radix-ui/react-accordion": "^1.2.12",
    "@radix-ui/react-alert-dialog": "^1.1.15",
    "@radix-ui/react-avatar": "^1.1.11",
    "@radix-ui/react-checkbox": "^1.3.3",
    "@radix-ui/react-collapsible": "^1.1.12",
    "@radix-ui/react-dialog": "^1.1.15",
    "@radix-ui/react-dropdown-menu": "^2.1.16",
    "@radix-ui/react-label": "^2.1.8",
    "@radix-ui/react-menubar": "^1.1.16",
    "@radix-ui/react-popover": "^1.1.15",
    "@radix-ui/react-progress": "^1.1.8",
    "@radix-ui/react-radio-group": "^1.3.8",
    "@radix-ui/react-scroll-area": "^1.2.10",
    "@radix-ui/react-select": "^2.2.6",
    "@radix-ui/react-separator": "^1.1.8",
    "@radix-ui/react-slider": "^1.3.6",
    "@radix-ui/react-slot": "^1.2.4",
    "@radix-ui/react-switch": "^1.2.6",
    "@radix-ui/react-tabs": "^1.1.13",
    "@radix-ui/react-toast": "^1.2.15",
    "@radix-ui/react-tooltip": "^1.2.8",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "dotenv": "^17.2.3",
    "embla-carousel-react": "^8.6.0",
    "firebase-admin": "^13.6.0",
    "google-auth-library": "^10.5.0",
    "lucide-react": "^0.562.0",
    "next": "^16.1.1",
    "react": "^19.2.3",
    "react-day-picker": "^9.13.0",
    "react-dom": "^19.2.3",
    "react-hook-form": "^7.69.0",
    "recharts": "^3.6.0",
    "tailwind-merge": "^3.4.0",
    "zod": "^3.25.76"
  },
  "devDependencies": {
    "@types/node": "^20.6.0",
    "@types/react": "19.2.7",
    "autoprefixer": "^10.4.14",
    "postcss": "^8.4.24",
    "tailwindcss": "^3.4.3",
    "tailwindcss-animate": "^1.0.7",
    "typescript": "^5.5.0"
  }
}
</file>

<file path="src/app/actions.ts">
'use server';

import {
  calculateManagementTrustScore,
  ManagementTrustScoreInput,
  ManagementTrustScoreOutput,
} from '@/ai/flows/management-trust-score';
import {
  simulatePortfolioImpact,
  SimulatePortfolioImpactInput,
  SimulatePortfolioImpactOutput,
} from '@/ai/flows/portfolio-impact-of-macro-events';
import {
  summarizeRiskFactors,
  SummarizeRiskFactorsInput,
  SummarizeRiskFactorsOutput,
} from '@/ai/flows/summarize-risk-factors';
import {
  checkForRedFlags,
  RegulatoryWatchInput,
  RegulatoryWatchOutput,
} from '@/ai/flows/regulatory-watch';

export async function handleManagementTrustScore(
  input: ManagementTrustScoreInput | { portfolioId: string }
): Promise<{ data: ManagementTrustScoreOutput | null; error: string | null }> {
  try {
    if ((input as any).portfolioId) {
      const { getPortfolioById } = await import('@/lib/portfolio');
      const { getCompanyById } = await import('@/lib/companies');
      const { getCachedResult, setCachedResult } = await import('@/lib/aiCache');
      const { logStructured } = await import('@/lib/logging');

      const portfolioId = (input as any).portfolioId;

      // Check cache
      const cached = await getCachedResult('managementTrustScore', { portfolioId });
      if (cached) {
        logStructured('INFO', 'Returning cached managementTrustScore', { portfolioId });
        return { data: JSON.parse(cached.resultJson) as ManagementTrustScoreOutput, error: null };
      }

      const p = await getPortfolioById(portfolioId);
      if (!p || !p.holdings || p.holdings.length === 0) throw new Error('Portfolio or holdings not found');
      const first = p.holdings[0];
      const company = await getCompanyById(first.companyId);
      const payload: ManagementTrustScoreInput = { companyName: company?.name ?? first.companyId, financialData: [] };

      const start = Date.now();
      const output = await calculateManagementTrustScore(payload);
      const latencyMs = Date.now() - start;

      // Save to cache
      await setCachedResult('managementTrustScore', { portfolioId, resultJson: JSON.stringify(output), latencyMs, model: process.env.GEMINI_MODEL || 'gemini-flash-latest' });
      logStructured('INFO', 'Computed and cached managementTrustScore', { portfolioId, latencyMs });

      return { data: output, error: null };
    }

    const output = await calculateManagementTrustScore(input as ManagementTrustScoreInput);
    return { data: output, error: null };
  } catch (e: any) {
    console.error(e);
    return { data: null, error: e.message || 'An unknown error occurred.' };
  }
}

export async function handleMacroShock(
  input: SimulatePortfolioImpactInput | { portfolioId: string; macroEvent: string }
): Promise<{ data: SimulatePortfolioImpactOutput | null; error: string | null }> {
  try {
    // If client sent only a portfolioId, construct portfolioHoldings server-side
    if ((input as any).portfolioId) {
      const { getPortfolioById, portfolioHoldingsToText } = await import('@/lib/portfolio');
      const { getCachedResult, setCachedResult } = await import('@/lib/aiCache');
      const { logStructured } = await import('@/lib/logging');
      const { extractCompanyNames, searchMultipleCompanies, formatTavilyResultsForAI } = await import('@/lib/tavily');

      const portfolioId = (input as any).portfolioId;

      // Try cache first - use cached result even if it's missing optional fields to save API calls
      const cached = await getCachedResult('macroShock', { portfolioId, input: { macroEvent: (input as any).macroEvent } });
      if (cached) {
        try {
          const parsedCached = JSON.parse(cached.resultJson) as any;
          logStructured('INFO', 'Returning cached macroShock', { portfolioId, macroEvent: (input as any).macroEvent });
          return { data: parsedCached as SimulatePortfolioImpactOutput, error: null };
        } catch (parseError) {
          logStructured('WARN', 'Failed to parse cached result, will recompute', { portfolioId, error: (parseError as Error).message });
          // Continue to recompute if parsing fails
        }
      }

      const p = await getPortfolioById(portfolioId);
      if (!p) throw new Error('Portfolio not found');
      const holdingsText = portfolioHoldingsToText(p);
      
      // Extract company names and fetch real-time data from Tavily
      const companyNames = extractCompanyNames(holdingsText);
      let tavilyContext = '';
      
      if (companyNames.length > 0) {
        try {
          logStructured('INFO', 'Fetching Tavily data for companies', { companies: companyNames });
          const tavilyResults = await searchMultipleCompanies(companyNames, 3);
          
          // Format Tavily results into context
          for (const [companyName, results] of tavilyResults) {
            tavilyContext += formatTavilyResultsForAI(companyName, results);
          }
          
          logStructured('INFO', 'Tavily data fetched successfully', { companiesCount: companyNames.length });
        } catch (tavilyError: any) {
          // Log error but don't fail the entire request
          logStructured('WARN', 'Tavily API error (continuing without real-time data)', { error: tavilyError.message });
        }
      }

      const payload: SimulatePortfolioImpactInput = { 
        portfolioHoldings: holdingsText, 
        macroEvent: (input as any).macroEvent,
        tavilyContext: tavilyContext // Add Tavily context to payload
      };

      const start = Date.now();
      const output = await simulatePortfolioImpact(payload);
      const latencyMs = Date.now() - start;

      // Save to cache
      await setCachedResult('macroShock', { portfolioId, input: { macroEvent: (input as any).macroEvent }, resultJson: JSON.stringify(output), latencyMs, model: process.env.GEMINI_MODEL || 'gemini-flash-latest' });

      logStructured('INFO', 'Computed and cached macroShock', { portfolioId, macroEvent: (input as any).macroEvent, latencyMs });

      return { data: output, error: null };
    }

    // Handle direct input (with portfolioHoldings text)
    const { extractCompanyNames, searchMultipleCompanies, formatTavilyResultsForAI } = await import('@/lib/tavily');
    const { logStructured } = await import('@/lib/logging');
    
    const directInput = input as SimulatePortfolioImpactInput;
    const companyNames = extractCompanyNames(directInput.portfolioHoldings);
    let tavilyContext = '';
    
    if (companyNames.length > 0) {
      try {
        logStructured('INFO', 'Fetching Tavily data for companies', { companies: companyNames });
        const tavilyResults = await searchMultipleCompanies(companyNames, 3);
        
        for (const [companyName, results] of tavilyResults) {
          tavilyContext += formatTavilyResultsForAI(companyName, results);
        }
        
        logStructured('INFO', 'Tavily data fetched successfully', { companiesCount: companyNames.length });
      } catch (tavilyError: any) {
        logStructured('WARN', 'Tavily API error (continuing without real-time data)', { error: tavilyError.message });
      }
    }

    const enhancedInput: SimulatePortfolioImpactInput = {
      ...directInput,
      tavilyContext: tavilyContext
    };

    const output = await simulatePortfolioImpact(enhancedInput);
    return { data: output, error: null };
  } catch (e: any) {
    console.error(e);
    return { data: null, error: e.message || 'An unknown error occurred.' };
  }
}

export async function handleRiskSummary(
  input: SummarizeRiskFactorsInput | { portfolioId: string }
): Promise<{ data: SummarizeRiskFactorsOutput | null; error: string | null }> {
  try {
    if ((input as any).portfolioId) {
      const { getPortfolioById } = await import('@/lib/portfolio');
      const { getCompanyById } = await import('@/lib/companies');
      const { getCachedResult, setCachedResult } = await import('@/lib/aiCache');
      const { logStructured } = await import('@/lib/logging');

      const portfolioId = (input as any).portfolioId;
      const cached = await getCachedResult('riskSummary', { portfolioId });
      if (cached) {
        logStructured('INFO', 'Returning cached riskSummary', { portfolioId });
        return { data: JSON.parse(cached.resultJson) as SummarizeRiskFactorsOutput, error: null };
      }

      const p = await getPortfolioById(portfolioId);
      if (!p || !p.holdings || p.holdings.length === 0) throw new Error('Portfolio or holdings not found');
      const first = p.holdings[0];
      const company = await getCompanyById(first.companyId);
      const payload: SummarizeRiskFactorsInput = { companyName: company?.name ?? first.companyId, financialReport: '' };

      const start = Date.now();
      const output = await summarizeRiskFactors(payload);
      const latencyMs = Date.now() - start;

      await setCachedResult('riskSummary', { portfolioId, resultJson: JSON.stringify(output), latencyMs, model: process.env.GEMINI_MODEL || 'gemini-flash-latest' });
      logStructured('INFO', 'Computed and cached riskSummary', { portfolioId, latencyMs });

      return { data: output, error: null };
    }

    const output = await summarizeRiskFactors(input as SummarizeRiskFactorsInput);
    return { data: output, error: null };
  } catch (e: any) {
    console.error(e);
    return { data: null, error: e.message || 'An unknown error occurred.' };
  }
}

/**
 * Fetch web insights for portfolio holdings using Tavily API
 */
export async function fetchPortfolioInsights(
  holdingsText: string
): Promise<{ data: Record<string, any> | null; error: string | null }> {
  try {
    const { extractCompanyNames, searchMultipleCompanies } = await import('@/lib/tavily');
    const { logStructured } = await import('@/lib/logging');

    const companyNames = extractCompanyNames(holdingsText);
    
    if (companyNames.length === 0) {
      return { data: {}, error: null };
    }

    logStructured('INFO', 'Fetching Tavily insights for portfolio', { companies: companyNames });
    const tavilyResults = await searchMultipleCompanies(companyNames, 5);
    
    // Convert Map to plain object for JSON serialization
    const resultsObj: Record<string, any> = {};
    for (const [companyName, results] of tavilyResults) {
      resultsObj[companyName] = results;
    }

    logStructured('INFO', 'Tavily insights fetched successfully', { companiesCount: companyNames.length });
    
    return { data: resultsObj, error: null };
  } catch (e: any) {
    console.error('Error fetching portfolio insights:', e);
    const { logStructured } = await import('@/lib/logging');
    logStructured('ERROR', 'Failed to fetch Tavily insights', { error: e.message });
    return { data: null, error: e.message || 'Failed to fetch web insights' };
  }
}

export async function handleRegulatoryWatch(
  input: RegulatoryWatchInput | { portfolioId: string }
): Promise<{ data: RegulatoryWatchOutput | null; error: string | null }> {
  try {
    if ((input as any).portfolioId) {
      const { getPortfolioById } = await import('@/lib/portfolio');
      const { getCompanyById } = await import('@/lib/companies');
      const { getCachedResult, setCachedResult } = await import('@/lib/aiCache');
      const { logStructured } = await import('@/lib/logging');

      const portfolioId = (input as any).portfolioId;
      const cached = await getCachedResult('regulatoryWatch', { portfolioId });
      if (cached) {
        logStructured('INFO', 'Returning cached regulatoryWatch', { portfolioId });
        return { data: JSON.parse(cached.resultJson) as RegulatoryWatchOutput, error: null };
      }

      const p = await getPortfolioById(portfolioId);
      if (!p || !p.holdings || p.holdings.length === 0) throw new Error('Portfolio or holdings not found');
      const first = p.holdings[0];
      const company = await getCompanyById(first.companyId);
      const payload: RegulatoryWatchInput = { companyName: company?.name ?? first.companyId, filingText: '' };

      const start = Date.now();
      const output = await checkForRedFlags(payload);
      const latencyMs = Date.now() - start;

      await setCachedResult('regulatoryWatch', { portfolioId, resultJson: JSON.stringify(output), latencyMs, model: process.env.GEMINI_MODEL || 'gemini-flash-latest' });
      logStructured('INFO', 'Computed and cached regulatoryWatch', { portfolioId, latencyMs });

      return { data: output, error: null };
    }

    const output = await checkForRedFlags(input as RegulatoryWatchInput);
    return { data: output, error: null };
  } catch (e: any) {
    console.error(e);
    return { data: null, error: e.message || 'An unknown error occurred.' };
  }
}
</file>

<file path="src/components/layout/app-layout.tsx">
'use client';
import React from 'react';
import { usePathname } from 'next/navigation';
import {
  SidebarProvider,
  Sidebar,
  SidebarHeader,
  SidebarContent,
  SidebarMenu,
  SidebarMenuItem,
  SidebarMenuButton,
  SidebarInset,
  SidebarFooter,
} from '@/components/ui/sidebar';
import {
  LayoutDashboard,
  ShieldCheck,
  TrendingUp,
  FileText,
  BotMessageSquare,
  Settings,
  CircleHelp,
  FileWarning,
} from 'lucide-react';
import { Header } from './header';

export default function AppLayout({ children }: { children: React.ReactNode }) {
  const pathname = usePathname();

  return (
    <SidebarProvider>
      <Sidebar>
        <SidebarHeader>
          <div className="flex items-center gap-2 p-2">
            <BotMessageSquare className="w-8 h-8 text-primary" />
            <h1 className="text-xl font-bold text-primary-foreground font-headline">
              ClearFinanceAI
            </h1>
          </div>
        </SidebarHeader>
        <SidebarContent>
          <SidebarMenu>
            <SidebarMenuItem>
              <SidebarMenuButton
                href="/dashboard"
                isActive={pathname === '/dashboard'}
                tooltip="Dashboard"
              >
                <LayoutDashboard />
                <span>Dashboard</span>
              </SidebarMenuButton>
            </SidebarMenuItem>
            <SidebarMenuItem>
              <SidebarMenuButton
                href="/management-trust"
                isActive={pathname === '/management-trust'}
                tooltip="Management Trust"
              >
                <ShieldCheck />
                <span>Management Trust</span>
              </SidebarMenuButton>
            </SidebarMenuItem>
            <SidebarMenuItem>
              <SidebarMenuButton
                href="/macro-simulation"
                isActive={pathname === '/macro-simulation'}
                tooltip="Macro Simulation"
              >
                <TrendingUp />
                <span>Macro Simulation</span>
              </SidebarMenuButton>
            </SidebarMenuItem>
            <SidebarMenuItem>
              <SidebarMenuButton
                href="/risk-analysis"
                isActive={pathname === '/risk-analysis'}
                tooltip="Risk Analysis"
              >
                <FileText />
                <span>Risk Analysis</span>
              </SidebarMenuButton>
            </SidebarMenuItem>
             <SidebarMenuItem>
              <SidebarMenuButton
                href="/regulatory-watch"
                isActive={pathname === '/regulatory-watch'}
                tooltip="Regulatory Watch"
              >
                <FileWarning />
                <span>Regulatory Watch</span>
              </SidebarMenuButton>
            </SidebarMenuItem>
          </SidebarMenu>
        </SidebarContent>
        <SidebarFooter>
          <SidebarMenu>
            <SidebarMenuItem>
              <SidebarMenuButton href="#" tooltip="Settings">
                <Settings />
                <span>Settings</span>
              </SidebarMenuButton>
            </SidebarMenuItem>
            <SidebarMenuItem>
              <SidebarMenuButton href="#" tooltip="Help">
                <CircleHelp />
                <span>Help</span>
              </SidebarMenuButton>
            </SidebarMenuItem>
          </SidebarMenu>
        </SidebarFooter>
      </Sidebar>
      <SidebarInset>
        <Header />
        {children}
      </SidebarInset>
    </SidebarProvider>
  );
}
</file>

<file path="src/app/page.tsx">
import { redirect } from 'next/navigation';

export default async function Home() {
  // Always redirect to dashboard
  redirect('/dashboard');
  return null;
}
</file>

</files>
